<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameChanger Admin Dashboard</title>
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-color: #00ff88;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --danger-color: #ff4757;
            --warning-color: #ffa502;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --user-a-color: #00ff88;
            --user-b-color: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.15);
        }

        .stat-card h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .user-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .user-stat {
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            text-align: center;
            min-width: 0;
            overflow: hidden;
        }

        .user-stat > div:first-child {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-stat > div:last-child {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-a { border-left: 4px solid var(--user-a-color); }
        .user-b { border-left: 4px solid var(--user-b-color); }

        .activities-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .activity-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            height: calc(100vh - 400px);
            min-height: 400px;
            max-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .activity-card h3 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .activity-content::-webkit-scrollbar {
            width: 8px;
        }

        .activity-content::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 4px;
        }

        .activity-content::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .activity-content::-webkit-scrollbar-thumb:hover {
            background: #00cc6a;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .session-active {
            border-left: 4px solid var(--accent-color);
            background: rgba(0, 255, 136, 0.1);
        }

        .session-user {
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .session-user.user-a { background: var(--user-a-color); color: #000; }
        .session-user.user-b { background: var(--user-b-color); color: #fff; }

        .btn {
            background: linear-gradient(135deg, var(--accent-color), #00cc6a);
            color: #000;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3);
        }

        .btn.warning {
            background: linear-gradient(135deg, var(--warning-color), #ff9500);
            color: white;
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            font-size: 1.2rem;
        }

        @media (max-width: 1024px) {
            .user-comparison {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .activity-card {
                height: calc(50vh - 100px);
                min-height: 300px;
            }
        }

        .theme-light {
            --primary-bg: #ffffff;
            --secondary-bg: #f6f8fa;
            --card-bg: #ffffff;
            --text-primary: #24292f;
            --text-secondary: #656d76;
            --border-color: #d0d7de;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚öôÔ∏è Admin Dashboard</h1>
            <p style="color: var(--text-secondary); font-size: 1.1rem;">Gesamt√ºbersicht aller Benutzer und Aktivit√§ten</p>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <h3>üìä Trading-Zeit</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="tradingA">00:00:00</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="tradingB">00:00:00</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üèÉ‚Äç‚ôÇÔ∏è Sport-Zeit</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="sportA">00:00:00</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="sportB">00:00:00</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üéµ GameDev/Piano-Zeit</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>GameDev Erik</div>
                        <div id="gamedevA">00:00:00</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Piano Eric</div>
                        <div id="pianoB">00:00:00</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üéØ T√§gliche Ziele</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="goalA">0%</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="goalB">0%</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>‚è±Ô∏è Gesamtzeiten</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="totalA">00:00:00</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="totalB">00:00:00</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üìä √ò T√§gliche Zeit</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="avgA">00:00:00</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="avgB">00:00:00</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üöÄ Produktivit√§t</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="productivityA">0%</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="productivityB">0%</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <h3>üìà 7-Tage Trend</h3>
                <div class="user-comparison">
                    <div class="user-stat user-a">
                        <div>Erik L√§hner</div>
                        <div id="trendA">0%</div>
                    </div>
                    <div class="user-stat user-b">
                        <div>Eric Tamme</div>
                        <div id="trendB">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activities Section -->
        <div class="activities-section">
            <div class="activity-card">
                <h3>üîÑ Aktive Sessions</h3>
                <div class="activity-content" id="activeSessions">
                    <div class="loading">Lade aktive Sessions...</div>
                </div>
            </div>

            <div class="activity-card">
                <h3>üìÖ Letzte Aktivit√§ten</h3>
                <div class="activity-content" id="recentActivities">
                    <div class="loading">Lade letzte Aktivit√§ten...</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
            <button class="btn warning" onclick="toggleTheme()">üé® Theme wechseln</button>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn refresh-btn" onclick="loadAllData()" title="Daten aktualisieren">üîÑ</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            doc,
            getDoc,
            getDocs,
            collection,
            query,
            orderBy,
            limit,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAujeUok4jKYwnr5GEXze_EadszqMdY1y4",
            authDomain: "gamechanger-78fb4.firebaseapp.com",
            projectId: "gamechanger-78fb4",
            storageBucket: "gamechanger-78fb4.firebasestorage.app",
            messagingSenderId: "510513691722",
            appId: "1:510513691722:web:c0c1a97141ddfda4377ab3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
            const seconds = String(totalSeconds % 60).padStart(2, "0");
            return `${hours}:${minutes}:${seconds}`;
        }

        async function getTodayData(user) {
            const heute = new Date().toISOString().slice(0, 10);
            const ref = doc(db, user, "training", "tage", heute);
            const snapshot = await getDoc(ref);
            
            if (snapshot.exists()) {
                const data = snapshot.data();
                if (user === "Benutzer_B") {
                    return {
                        tradingzeit: data.tradingzeit || 0,
                        sportzeit: data.sportzeit || 0,
                        gamedevzeit: data.pianozeit || 0
                    };
                } else {
                    return {
                        tradingzeit: data.tradingzeit || 0,
                        sportzeit: data.sportzeit || 0,
                        gamedevzeit: data.gamedevzeit || 0
                    };
                }
            }
            return { tradingzeit: 0, sportzeit: 0, gamedevzeit: 0 };
        }

        async function get7DayTrend(user) {
            try {
                const today = new Date();
                const productivityBaseTime = 3 * 60 * 60 * 1000; // 3 hours in ms
                let totalProductivity = 0;
                let validDays = 0;
                
                // Get productivity for last 7 days (excluding today)
                for (let i = 7; i >= 1; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const dateString = date.toISOString().slice(0, 10);
                    
                    try {
                        const ref = doc(db, user, "training", "tage", dateString);
                        const snapshot = await getDoc(ref);
                        
                        if (snapshot.exists()) {
                            const data = snapshot.data();
                            let dailyTime = 0;
                            
                            if (user === "Benutzer_B") {
                                dailyTime += data.tradingzeit || 0;
                                dailyTime += data.sportzeit || 0;
                                dailyTime += data.pianozeit || 0;
                            } else {
                                dailyTime += data.tradingzeit || 0;
                                dailyTime += data.sportzeit || 0;
                                dailyTime += data.gamedevzeit || 0;
                            }
                            
                            if (dailyTime > 0) {
                                const dailyProductivity = (dailyTime / productivityBaseTime) * 100;
                                totalProductivity += dailyProductivity;
                                validDays++;
                            }
                        }
                    } catch (error) {
                        console.log(`Fehler beim Laden von Tag ${dateString} f√ºr ${user}:`, error);
                    }
                }
                
                // Calculate 7-day average
                const avgProductivity = validDays > 0 ? totalProductivity / validDays : 0;
                
                // Get today's productivity
                const todayData = await getTodayData(user);
                const todayTime = (todayData.tradingzeit || 0) + (todayData.sportzeit || 0) + (todayData.gamedevzeit || 0);
                const todayProductivity = (todayTime / productivityBaseTime) * 100;
                
                // Calculate trend (difference between today and 7-day average)
                const trend = todayProductivity - avgProductivity;
                
                return {
                    trend: Math.round(trend),
                    avgProductivity: Math.round(avgProductivity),
                    todayProductivity: Math.round(todayProductivity)
                };
                
            } catch (error) {
                console.log(`Fehler beim Berechnen des 7-Tage-Trends f√ºr ${user}:`, error);
                return { trend: 0, avgProductivity: 0, todayProductivity: 0 };
            }
        }

        async function getAverageData(user) {
            try {
                const tageCollection = collection(db, user, "training", "tage");
                const snapshot = await getDocs(tageCollection);
                
                if (snapshot.empty) {
                    return { average: 0, days: 0 };
                }
                
                let totalTime = 0;
                let dayCount = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let dailyTotal = 0;
                    
                    if (user === "Benutzer_B") {
                        // F√ºr Benutzer B: Piano statt GameDev
                        dailyTotal += data.tradingzeit || 0;
                        dailyTotal += data.sportzeit || 0;
                        dailyTotal += data.pianozeit || 0;
                    } else {
                        // F√ºr Benutzer A: Standard GameDev
                        dailyTotal += data.tradingzeit || 0;
                        dailyTotal += data.sportzeit || 0;
                        dailyTotal += data.gamedevzeit || 0;
                    }
                    
                    // Nur Tage mit tats√§chlicher Aktivit√§t z√§hlen
                    if (dailyTotal > 0) {
                        totalTime += dailyTotal;
                        dayCount++;
                    }
                });
                
                const average = dayCount > 0 ? totalTime / dayCount : 0;
                
                return { average, days: dayCount };
            } catch (error) {
                console.log(`Fehler beim Laden der Durchschnittsdaten f√ºr ${user}:`, error);
                return { average: 0, days: 0 };
            }
        }

        async function getAllTimeData(user) {
            try {
                const tageCollection = collection(db, user, "training", "tage");
                const snapshot = await getDocs(tageCollection);
                
                let totalTrading = 0;
                let totalSport = 0;
                let totalGamedev = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (user === "Benutzer_B") {
                        totalTrading += data.tradingzeit || 0;
                        totalSport += data.sportzeit || 0;
                        totalGamedev += data.pianozeit || 0;
                    } else {
                        totalTrading += data.tradingzeit || 0;
                        totalSport += data.sportzeit || 0;
                        totalGamedev += data.gamedevzeit || 0;
                    }
                });
                
                return {
                    tradingzeit: totalTrading,
                    sportzeit: totalSport,
                    gamedevzeit: totalGamedev
                };
            } catch (error) {
                console.log(`Fehler beim Laden der Gesamtzeiten f√ºr ${user}:`, error);
                return { tradingzeit: 0, sportzeit: 0, gamedevzeit: 0 };
            }
        }

        async function getActiveSessions(user) {
            const sessions = [];
            let sessionTypes;
            
            if (user === "Benutzer_B") {
                sessionTypes = ['trading_current', 'sport_current', 'piano_current'];
            } else {
                sessionTypes = ['trading_current', 'sport_current', 'gamedev_current'];
            }
            
            for (let sessionType of sessionTypes) {
                try {
                    const ref = doc(db, user, "training", "sessions", sessionType);
                    const snapshot = await getDoc(ref);
                    
                    if (snapshot.exists() && snapshot.data().aktiv) {
                        const data = snapshot.data();
                        sessions.push({
                            user: user,
                            type: data.typ,
                            startTime: data.startZeit.toDate(),
                            duration: Date.now() - data.startZeit.toMillis()
                        });
                    }
                } catch (error) {
                    console.log(`Fehler beim Laden der Session ${sessionType} f√ºr ${user}:`, error);
                }
            }
            return sessions;
        }

        async function getRecentActivities(user, limitCount = 5) {
            const activities = [];
            let activityTypes;
            
            if (user === "Benutzer_B") {
                activityTypes = ['trading', 'sport', 'piano'];
            } else {
                activityTypes = ['trading', 'sport', 'gamedevelopment'];
            }
            
            for (let activityType of activityTypes) {
                try {
                    const q = query(
                        collection(db, user, "aktivitaeten", activityType),
                        orderBy("erstellt", "desc"),
                        limit(limitCount)
                    );
                    const snapshot = await getDocs(q);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        activities.push({
                            user: user,
                            type: data.typ,
                            duration: data.dauer,
                            startTime: data.startZeit.toDate(),
                            endTime: data.endZeit.toDate()
                        });
                    });
                } catch (error) {
                    console.log(`Keine Aktivit√§ten f√ºr ${activityType} in ${user}:`, error);
                }
            }
            
            return activities.sort((a, b) => b.startTime - a.startTime).slice(0, limitCount);
        }

        async function loadStatistics() {
            try {
                const dataA = await getTodayData("Benutzer_A");
                const dataB = await getTodayData("Benutzer_B");
                const allTimeA = await getAllTimeData("Benutzer_A");
                const allTimeB = await getAllTimeData("Benutzer_B");
                const avgDataA = await getAverageData("Benutzer_A");
                const avgDataB = await getAverageData("Benutzer_B");
                const trendA = await get7DayTrend("Benutzer_A");
                const trendB = await get7DayTrend("Benutzer_B");

                // Today's individual activities
                document.getElementById('tradingA').textContent = formatTime(dataA.tradingzeit || 0);
                document.getElementById('tradingB').textContent = formatTime(dataB.tradingzeit || 0);
                document.getElementById('sportA').textContent = formatTime(dataA.sportzeit || 0);
                document.getElementById('sportB').textContent = formatTime(dataB.sportzeit || 0);
                document.getElementById('gamedevA').textContent = formatTime(dataA.gamedevzeit || 0);
                document.getElementById('pianoB').textContent = formatTime(dataB.gamedevzeit || 0);

                // All-time totals
                const allTimeTotalA = (allTimeA.tradingzeit || 0) + (allTimeA.sportzeit || 0) + (allTimeA.gamedevzeit || 0);
                const allTimeTotalB = (allTimeB.tradingzeit || 0) + (allTimeB.sportzeit || 0) + (allTimeB.gamedevzeit || 0);

                document.getElementById('totalA').textContent = formatTime(allTimeTotalA);
                document.getElementById('totalB').textContent = formatTime(allTimeTotalB);

                // Average daily times
                document.getElementById('avgA').textContent = formatTime(avgDataA.average);
                document.getElementById('avgB').textContent = formatTime(avgDataB.average);

                // Productivity calculation (3 hours = 100%)
                const productivityBaseTime = 3 * 60 * 60 * 1000; // 3 hours in milliseconds
                const productivityA = avgDataA.average > 0 ? Math.round((avgDataA.average / productivityBaseTime) * 100) : 0;
                const productivityB = avgDataB.average > 0 ? Math.round((avgDataB.average / productivityBaseTime) * 100) : 0;
                
                document.getElementById('productivityA').textContent = productivityA + '%';
                document.getElementById('productivityB').textContent = productivityB + '%';

                // 7-day productivity trend (difference from 7-day average)
                const trendAText = trendA.trend > 0 ? `+${trendA.trend}%` : `${trendA.trend}%`;
                const trendBText = trendB.trend > 0 ? `+${trendB.trend}%` : `${trendB.trend}%`;
                
                document.getElementById('trendA').textContent = trendAText;
                document.getElementById('trendB').textContent = trendBText;

                // Add color coding for trends
                const trendAElement = document.getElementById('trendA');
                const trendBElement = document.getElementById('trendB');
                
                // Reset classes
                trendAElement.style.color = trendA.trend > 0 ? '#10b981' : (trendA.trend < 0 ? '#ef4444' : 'var(--text-primary)');
                trendBElement.style.color = trendB.trend > 0 ? '#10b981' : (trendB.trend < 0 ? '#ef4444' : 'var(--text-primary)');

                // Daily goals (based on today's data)
                const goalTime = 3 * 60 * 60 * 1000;
                const todayTotalA = (dataA.tradingzeit || 0) + (dataA.sportzeit || 0) + (dataA.gamedevzeit || 0);
                const todayTotalB = (dataB.tradingzeit || 0) + (dataB.sportzeit || 0) + (dataB.gamedevzeit || 0);
                
                const goalA = Math.min(Math.round((todayTotalA / goalTime) * 100), 100);
                const goalB = Math.min(Math.round((todayTotalB / goalTime) * 100), 100);
                
                document.getElementById('goalA').textContent = goalA + '%';
                document.getElementById('goalB').textContent = goalB + '%';

                return { dataA, dataB };
            } catch (error) {
                console.error('Fehler beim Laden der Statistiken:', error);
            }
        }

        async function loadActiveSessions() {
            try {
                const sessionsA = await getActiveSessions("Benutzer_A");
                const sessionsB = await getActiveSessions("Benutzer_B");
                const allSessions = [...sessionsA, ...sessionsB];

                const container = document.getElementById('activeSessions');
                
                if (allSessions.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Keine aktiven Sessions</p>';
                    return;
                }

                container.innerHTML = allSessions.map(session => `
                    <div class="session-item session-active">
                        <div>
                            <span class="session-user ${session.user === 'Benutzer_A' ? 'user-a' : 'user-b'}">
                                ${session.user === 'Benutzer_A' ? 'Erik' : 'Eric'}
                            </span>
                            <strong>${getActivityDisplayName(session.type)}</strong>
                        </div>
                        <div>
                            <span>${formatTime(session.duration)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fehler beim Laden der aktiven Sessions:', error);
            }
        }

        async function loadRecentActivities() {
            try {
                const activitiesA = await getRecentActivities("Benutzer_A", 10);
                const activitiesB = await getRecentActivities("Benutzer_B", 10);
                const allActivities = [...activitiesA, ...activitiesB];
                
                allActivities.sort((a, b) => b.startTime - a.startTime);
                
                const container = document.getElementById('recentActivities');
                
                if (allActivities.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Keine Aktivit√§ten gefunden</p>';
                    return;
                }

                container.innerHTML = allActivities.slice(0, 20).map(activity => `
                    <div class="session-item">
                        <div>
                            <span class="session-user ${activity.user === 'Benutzer_A' ? 'user-a' : 'user-b'}">
                                ${activity.user === 'Benutzer_A' ? 'Erik' : 'Eric'}
                            </span>
                            <strong>${getActivityDisplayName(activity.type)}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ${activity.startTime.toLocaleString('de-DE')}
                            </div>
                        </div>
                        <div>
                            <span>${formatTime(activity.duration)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Fehler beim Laden der letzten Aktivit√§ten:', error);
            }
        }

        function getActivityDisplayName(type) {
            const names = {
                'trading': 'üìà Trading',
                'sport': 'üèÉ‚Äç‚ôÇÔ∏è Sport',
                'gamedevelopment': 'üéÆ GameDev',
                'piano': 'üéπ Piano'
            };
            return names[type] || type;
        }

        async function loadAllData() {
            console.log('Loading all data...');
            
            try {
                await loadStatistics();
                await loadActiveSessions();
                await loadRecentActivities();
                
                console.log('All data loaded successfully');
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('theme-light');
            localStorage.setItem('theme', document.body.classList.contains('theme-light') ? 'light' : 'dark');
        }

        // Make functions globally available
        window.toggleTheme = toggleTheme;
        window.loadAllData = loadAllData;

        // Auth state handling
        onAuthStateChanged(auth, user => {
            if (!user) {
                console.log("Nicht eingeloggt");
                return;
            }
            console.log("Eingeloggt als:", user.email);
        });

        // Initialization function
        async function initializeDashboard() {
            try {
                // Theme setup
                if (localStorage.getItem('theme') === 'dark') {
                    // Keep default dark theme
                } else {
                    document.body.classList.add('theme-light');
                }

                // Initial data load
                await loadAllData();

                // Auto-refresh every 30 seconds
                setInterval(loadAllData, 30000);
                
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        }

        // Start initialization when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }
    </script>
</body>
</html>