<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Journal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1a202c;
            line-height: 1.4;
            min-height: 100vh;
            padding: 15px;
            font-size: 14px;
        }

        /* Compact Header */
        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Edit Indicator */
        #editIndicator {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            color: #92400e;
            padding: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
            font-size: 12px;
        }

        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 160px 1fr 480px;
            gap: 15px;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        /* Left Column - Form */
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .form-section h2 {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #667eea;
            font-weight: 600;
            text-align: center;
        }

        #tradeForm {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #tradeForm input,
        #tradeForm select {
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 11px;
            transition: all 0.3s ease;
            background: white;
            color: #1a202c;
        }

        #tradeForm input:focus,
        #tradeForm select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        #tradeForm button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            margin-top: 5px;
        }

        #tradeForm button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Middle Column - Table and Stats */
        .middle-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }

        /* Compact Stats */
        .stats-compact {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-compact {
            text-align: center;
        }

        .stat-compact .label {
            font-size: 11px;
            color: #4a5568;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .stat-compact .value {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-compact .value.positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-compact .value.negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Table Section */
        .table-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .table-section h2 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #667eea;
            font-weight: 600;
        }

        .table-container {
            overflow-y: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600;
            color: #1a202c;
            padding: 8px 6px;
            border: none;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 6px;
            border: none;
            border-bottom: 1px solid #f1f3f4;
            color: #1a202c;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }

        /* Result and Direction Styles */
        .result-tp {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 11px;
        }

        .result-be {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 11px;
        }

        .result-sl {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 11px;
        }

        .direction.buy {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 11px;
        }

        .direction.sell {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 11px;
        }

        .pnl-positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .pnl-negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* Buttons */
        .delete-btn,
        .edit-btn,
        .note-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 3px 5px;
            margin: 0 1px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #fee2e2;
            border-color: #f87171;
            transform: scale(1.1);
        }

        .edit-btn:hover {
            background: #dbeafe;
            border-color: #60a5fa;
            transform: scale(1.1);
        }

        .note-btn:hover {
            background: #fef3c7;
            border-color: #fbbf24;
            transform: scale(1.1);
        }

        /* Right Column - Charts */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .chart-mini {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            height: 200px;
            transition: all 0.3s ease;
        }

        .chart-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .chart-mini h3 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #1a202c;
            text-align: center;
            font-weight: 600;
        }

        .chart-container-mini {
            position: relative;
            height: 150px;
            padding: 5px;
        }

        /* Symbol Performance Compact */
        .symbol-list-compact {
            height: 150px;
            overflow-y: auto;
            padding: 5px;
            margin-top: 5px;
        }

        .symbol-list-compact::-webkit-scrollbar {
            width: 4px;
        }

        .symbol-list-compact::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 2px;
        }

        .symbol-list-compact::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.4);
            border-radius: 2px;
        }

        .symbol-list-compact::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.6);
        }

        /* Comprehensive Analysis Section */
        .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            height: 320px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .analysis-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .analysis-header h3 {
            font-size: 0.9rem;
            color: #1a202c;
            font-weight: 600;
            margin: 0;
        }

        .analysis-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .analysis-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .analysis-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .analysis-content {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
            font-size: 11px;
            line-height: 1.4;
        }

        .analysis-content::-webkit-scrollbar {
            width: 4px;
        }

        .analysis-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 2px;
        }

        .analysis-content::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.4);
            border-radius: 2px;
        }

        .analysis-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6b7280;
        }

        .placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .analysis-category {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 4px solid;
        }

        .analysis-category.performance { border-left-color: #10b981; }
        .analysis-category.risk { border-left-color: #ef4444; }
        .analysis-category.strategy { border-left-color: #3b82f6; }
        .analysis-category.time { border-left-color: #f59e0b; }
        .analysis-category.psychology { border-left-color: #8b5cf6; }
        .analysis-category.recommendations { border-left-color: #06b6d4; }

        .category-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a202c;
            font-size: 12px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        .metric-item {
            background: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-label {
            font-size: 9px;
            color: #6b7280;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 13px;
            font-weight: 700;
        }

        .metric-value.positive { color: #10b981; }
        .metric-value.negative { color: #ef4444; }
        .metric-value.neutral { color: #3b82f6; }

        .insight-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            padding: 6px;
            margin-bottom: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            font-size: 10px;
        }

        .insight-icon {
            font-size: 12px;
            margin-top: 1px;
            flex-shrink: 0;
        }

        .insight-text {
            flex: 1;
            line-height: 1.3;
        }

        .progress-bar-container {
            margin: 6px 0;
        }

        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        .progress-fill.excellent { background: linear-gradient(90deg, #10b981, #059669); }
        .progress-fill.good { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .progress-fill.average { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .progress-fill.poor { background: linear-gradient(90deg, #ef4444, #dc2626); }

        .score-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-badge.excellent {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
        }

        .score-badge.good {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .score-badge.average {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }

        .score-badge.poor {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }

        .mini-chart {
            width: 100%;
            height: 60px;
            margin: 6px 0;
        }

        .recommendation-item {
            background: white;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 3px solid;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .recommendation-item.high { border-left-color: #ef4444; }
        .recommendation-item.medium { border-left-color: #f59e0b; }
        .recommendation-item.low { border-left-color: #10b981; }

        .recommendation-title {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .recommendation-text {
            font-size: 9px;
            color: #4b5563;
            line-height: 1.3;
        }



        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content textarea {
            width: 94%;
            padding: 10px;
            margin: 10px 0;
            resize: vertical;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .modal-content button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .modal-content button:hover {
            background-color: #218838;
            transform: scale(1.05);
        }

        .close-btn {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 140px 1fr 400px;
            }
            
            .stats-compact {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 120px 1fr 350px;
            }
            
            .charts-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .chart-mini {
                height: 180px;
            }
            
            .stats-compact {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1000px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                height: auto;
            }
            
            .charts-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .chart-mini {
                height: 180px;
            }
            
            .stats-compact {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .main-container {
                gap: 10px;
            }
            
            .stats-compact {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üìì Trading Journal</h1>

    <div id="editIndicator">‚úèÔ∏è Bearbeitungsmodus ‚Äì √Ñnderungen speichern oder abbrechen</div>

    <div class="main-container">
        <!-- Left Column - Form -->
        <div class="form-section">
            <h2>‚ûï Neuer Trade</h2>
            <form id="tradeForm">
                <input type="date" id="date" placeholder="Datum" required />
                <input type="text" id="symbol" placeholder="Symbol" />
                <select id="direction">
                    <option value="">Trade-Richtung</option>
                    <option value="Buy">Buy</option>
                    <option value="Sell">Sell</option>
                </select>
                <input type="url" id="entryScreenshot" placeholder="Einstieg Link" />
                <input type="url" id="exitScreenshot" placeholder="Ausstieg Link" />
                <select id="result">
                    <option value="">Ergebnis</option>
                    <option value="TP">TP</option>
                    <option value="BE">BE</option>
                    <option value="SL">SL</option>
                </select>
                <input type="number" step="0.01" id="pnl" placeholder="PnL (%)" />
                <input type="text" id="strategy" placeholder="Strategie" />
                <button type="submit">Hinzuf√ºgen</button>
            </form>
        </div>

        <!-- Middle Column - Stats and Table -->
        <div class="middle-section">
            <!-- Compact Stats -->
            <div class="stats-compact">
                <div class="stat-compact">
                    <div class="label">Trades</div>
                    <div class="value" id="totalTrades">0</div>
                </div>
                <div class="stat-compact">
                    <div class="label">Winrate</div>
                    <div class="value" id="winRate">0%</div>
                </div>
                <div class="stat-compact">
                    <div class="label">PnL</div>
                    <div class="value" id="totalPnL">0%</div>
                </div>
                <div class="stat-compact">
                    <div class="label">√ò Gewinn</div>
                    <div class="value positive" id="avgWin">0%</div>
                </div>
                <div class="stat-compact">
                    <div class="label">√ò Verlust</div>
                    <div class="value negative" id="avgLoss">0%</div>
                </div>
                <div class="stat-compact">
                    <div class="label">Bester</div>
                    <div class="value positive" id="bestTrade">0%</div>
                </div>
                <div class="stat-compact">
                    <div class="label">Gr√∂√üter Verlust</div>
                    <div class="value negative" id="worstTrade">0%</div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <h2>üìä Trading History</h2>
                <div class="table-container">
                    <table id="journal">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Symbol</th>
                                <th>Richtung</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Result</th>
                                <th>PnL</th>
                                <th>Strategie</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column - Charts -->
        <div class="charts-section">
            <div class="chart-mini">
                <h3>üìà PnL Chart</h3>
                <div class="chart-container-mini">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>

            <div class="chart-mini">
                <h3>üéØ Results</h3>
                <div class="chart-container-mini">
                    <canvas id="resultsChart"></canvas>
                </div>
            </div>

            <div class="chart-mini">
                <h3>üìä Strategies</h3>
                <div class="chart-container-mini">
                    <canvas id="strategyChart"></canvas>
                </div>
            </div>

            <div class="chart-mini">
                <h3>üíπ Symbols</h3>
                <div class="symbol-list-compact" id="symbolPerformanceList">
                    <!-- Symbol items will be inserted here -->
                </div>
            </div>

            <!-- Comprehensive Analysis Section -->
            <div class="analysis-section">
                <div class="analysis-header">
                    <h3>üéØ Umfassende Trading-Analyse</h3>
                    <button id="generateAnalysisBtn" class="analysis-btn">
                        üìä Vollanalyse generieren
                    </button>
                </div>
                <div id="analysisContent" class="analysis-content">
                    <div class="analysis-placeholder">
                        <div class="placeholder-icon">üöÄ</div>
                        <p>Klicke auf "Vollanalyse generieren" f√ºr eine detaillierte Auswertung deiner Trading-Performance</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="noteModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeNoteModal()">√ó</span>
            <h3>üìù Notiz zum Trade</h3>
            <textarea id="noteInput" rows="5" placeholder="Deine Notiz..."></textarea>
            <button onclick="saveNote()">Speichern</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAujeUok4jKYwnr5GEXze_EadszqMdY1y4",
            authDomain: "gamechanger-78fb4.firebaseapp.com",
            projectId: "gamechanger-78fb4",
            storageBucket: "gamechanger-78fb4.firebasestorage.app",
            messagingSenderId: "510513691722",
            appId: "1:510513691722:web:c0c1a97141ddfda4377ab3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tradesRef = db.collection("users").doc("a").collection("trades");

        const form = document.getElementById("tradeForm");
        const tbody = document.querySelector("#journal tbody");
        const editIndicator = document.getElementById("editIndicator");
        let currentNoteId = null;
        let editingTradeId = null;
        let allTrades = [];

        // Chart Instanzen
        let pnlChart, resultsChart, strategyChart;

        // === Comprehensive Trading Analysis Functions ===
        function generateComprehensiveAnalysis(trades) {
            if (trades.length === 0) {
                document.getElementById('analysisContent').innerHTML = `
                    <div class="analysis-placeholder">
                        <div class="placeholder-icon">üìä</div>
                        <p>Keine Trades vorhanden f√ºr die Analyse</p>
                    </div>
                `;
                return;
            }

            const analysis = performComprehensiveAnalysis(trades);
            const analysisHTML = generateComprehensiveAnalysisHTML(analysis);
            
            document.getElementById('analysisContent').innerHTML = analysisHTML;
        }

        function performComprehensiveAnalysis(trades) {
            // Sort trades chronologically
            const sortedTrades = [...trades].sort((a, b) => {
                const [dayA, monthA, yearA] = (a.date || '01-01-1970').split("-").map(Number);
                const [dayB, monthB, yearB] = (b.date || '01-01-1970').split("-").map(Number);
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });

            // Basic Performance Metrics
            const performance = analyzePerformance(sortedTrades);
            
            // Risk Management Analysis
            const risk = analyzeRiskManagement(sortedTrades);
            
            // Strategy Analysis
            const strategies = analyzeStrategies(sortedTrades);
            
            // Symbol Analysis
            const symbols = analyzeSymbols(sortedTrades);
            
            // Time Analysis
            const timeAnalysis = analyzeTimePatterns(sortedTrades);
            
            // Psychology Analysis
            const psychology = analyzePsychology(sortedTrades);
            
            // Generate Recommendations
            const recommendations = generateRecommendations({
                performance, risk, strategies, symbols, timeAnalysis, psychology, trades: sortedTrades
            });

            return {
                performance,
                risk,
                strategies,
                symbols,
                timeAnalysis,
                psychology,
                recommendations
            };
        }

        function analyzePerformance(trades) {
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => (t.pnl || 0) > 0);
            const losingTrades = trades.filter(t => (t.pnl || 0) < 0);
            const breakEvenTrades = trades.filter(t => (t.pnl || 0) === 0);
            
            const totalPnL = trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades) * 100 : 0;
            
            const avgWin = winningTrades.length > 0 ? 
                winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? 
                Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length) : 0;
            
            const bestTrade = trades.length > 0 ? Math.max(...trades.map(t => t.pnl || 0)) : 0;
            const worstTrade = trades.length > 0 ? Math.min(...trades.map(t => t.pnl || 0)) : 0;
            
            const riskRewardRatio = avgLoss > 0 ? avgWin / avgLoss : 0;
            const profitFactor = losingTrades.length > 0 ? 
                Math.abs(winningTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.reduce((sum, t) => sum + t.pnl, 0)) : 
                (winningTrades.length > 0 ? 999 : 0);

            // Calculate cumulative PnL for drawdown analysis
            let cumulativePnL = 0;
            let peak = 0;
            let maxDrawdown = 0;
            const pnlCurve = [];

            trades.forEach(trade => {
                cumulativePnL += trade.pnl || 0;
                pnlCurve.push(cumulativePnL);
                peak = Math.max(peak, cumulativePnL);
                const drawdown = peak - cumulativePnL;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
            });

            // Calculate consistency score
            const avgTradePnL = totalPnL / totalTrades;
            const variance = trades.reduce((sum, t) => sum + Math.pow((t.pnl || 0) - avgTradePnL, 2), 0) / totalTrades;
            const standardDeviation = Math.sqrt(variance);
            const consistencyScore = standardDeviation > 0 ? Math.max(0, 100 - (standardDeviation * 10)) : 100;

            return {
                totalTrades, winRate, totalPnL, avgWin, avgLoss, bestTrade, worstTrade,
                riskRewardRatio, profitFactor, maxDrawdown, consistencyScore, pnlCurve,
                winningTrades: winningTrades.length,
                losingTrades: losingTrades.length,
                breakEvenTrades: breakEvenTrades.length
            };
        }

        function analyzeRiskManagement(trades) {
            const losses = trades.filter(t => (t.pnl || 0) < 0).map(t => t.pnl);
            const gains = trades.filter(t => (t.pnl || 0) > 0).map(t => t.pnl);
            
            // Consecutive losses analysis
            let currentStreak = 0;
            let maxLossStreak = 0;
            let maxWinStreak = 0;
            let currentWinStreak = 0;
            
            trades.forEach(trade => {
                if ((trade.pnl || 0) < 0) {
                    currentStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentStreak);
                } else if ((trade.pnl || 0) > 0) {
                    currentWinStreak++;
                    currentStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else {
                    currentStreak = 0;
                    currentWinStreak = 0;
                }
            });

            // Risk per trade analysis
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((a, b) => a + b, 0) / losses.length) : 0;
            const maxLoss = losses.length > 0 ? Math.abs(Math.min(...losses)) : 0;
            
            // Risk score (0-100, higher is better)
            let riskScore = 100;
            if (maxLoss > 10) riskScore -= 30; // Penalize large single losses
            if (maxLossStreak > 5) riskScore -= 20; // Penalize long losing streaks
            if (avgLoss > 3) riskScore -= 20; // Penalize high average losses
            riskScore = Math.max(0, riskScore);

            return {
                maxLossStreak,
                maxWinStreak,
                avgLoss,
                maxLoss,
                riskScore,
                lossesCount: losses.length,
                gainsCount: gains.length
            };
        }

        function analyzeStrategies(trades) {
            const strategies = {};
            
            trades.forEach(trade => {
                const strategy = trade.strategy || 'Keine Strategie';
                if (!strategies[strategy]) {
                    strategies[strategy] = {
                        trades: [], totalPnL: 0, wins: 0, losses: 0
                    };
                }
                strategies[strategy].trades.push(trade);
                strategies[strategy].totalPnL += trade.pnl || 0;
                if ((trade.pnl || 0) > 0) strategies[strategy].wins++;
                if ((trade.pnl || 0) < 0) strategies[strategy].losses++;
            });

            const strategyAnalysis = Object.entries(strategies).map(([name, stats]) => ({
                name,
                totalTrades: stats.trades.length,
                totalPnL: stats.totalPnL,
                winRate: (stats.wins / stats.trades.length) * 100,
                avgPnL: stats.totalPnL / stats.trades.length,
                wins: stats.wins,
                losses: stats.losses,
                consistency: calculateStrategyConsistency(stats.trades)
            })).sort((a, b) => b.totalPnL - a.totalPnL);

            return strategyAnalysis;
        }

        function calculateStrategyConsistency(trades) {
            if (trades.length < 2) return 50;
            const avgPnL = trades.reduce((sum, t) => sum + (t.pnl || 0), 0) / trades.length;
            const variance = trades.reduce((sum, t) => sum + Math.pow((t.pnl || 0) - avgPnL, 2), 0) / trades.length;
            const standardDeviation = Math.sqrt(variance);
            return Math.max(0, Math.min(100, 100 - (standardDeviation * 8)));
        }

        function analyzeSymbols(trades) {
            const symbols = {};
            
            trades.forEach(trade => {
                const symbol = trade.symbol || 'Unbekannt';
                if (!symbols[symbol]) {
                    symbols[symbol] = {
                        trades: [], totalPnL: 0, wins: 0, losses: 0
                    };
                }
                symbols[symbol].trades.push(trade);
                symbols[symbol].totalPnL += trade.pnl || 0;
                if ((trade.pnl || 0) > 0) symbols[symbol].wins++;
                if ((trade.pnl || 0) < 0) symbols[symbol].losses++;
            });

            const symbolAnalysis = Object.entries(symbols).map(([name, stats]) => ({
                name,
                totalTrades: stats.trades.length,
                totalPnL: stats.totalPnL,
                winRate: (stats.wins / stats.trades.length) * 100,
                avgPnL: stats.totalPnL / stats.trades.length
            })).sort((a, b) => b.totalPnL - a.totalPnL);

            // Diversification score
            const totalTrades = trades.length;
            const symbolCount = symbolAnalysis.length;
            const diversificationScore = symbolCount > 1 ? Math.min(100, (symbolCount / Math.sqrt(totalTrades)) * 50) : 0;

            return { symbols: symbolAnalysis, diversificationScore };
        }

        function analyzeTimePatterns(trades) {
            const monthly = {};
            const weekday = {};
            
            trades.forEach(trade => {
                if (!trade.date) return;
                
                const [day, month, year] = trade.date.split('-');
                const date = new Date(year, month - 1, day);
                const monthKey = `${month}/${year}`;
                const dayName = date.toLocaleDateString('de-DE', { weekday: 'long' });
                
                // Monthly analysis
                if (!monthly[monthKey]) {
                    monthly[monthKey] = { trades: 0, pnl: 0, wins: 0 };
                }
                monthly[monthKey].trades++;
                monthly[monthKey].pnl += trade.pnl || 0;
                if ((trade.pnl || 0) > 0) monthly[monthKey].wins++;
                
                // Weekday analysis
                if (!weekday[dayName]) {
                    weekday[dayName] = { trades: 0, pnl: 0, wins: 0 };
                }
                weekday[dayName].trades++;
                weekday[dayName].pnl += trade.pnl || 0;
                if ((trade.pnl || 0) > 0) weekday[dayName].wins++;
            });

            return { monthly, weekday };
        }

        function analyzePsychology(trades) {
            let revengeTrading = 0;
            let overtrading = 0;
            let emotionalTrades = 0;
            
            // Analyze for revenge trading (large trades after losses)
            for (let i = 1; i < trades.length; i++) {
                const prevTrade = trades[i-1];
                const currentTrade = trades[i];
                
                if ((prevTrade.pnl || 0) < -5 && Math.abs(currentTrade.pnl || 0) > Math.abs(prevTrade.pnl || 0) * 1.5) {
                    revengeTrading++;
                }
            }
            
            // Analyze for overtrading (more than 5 trades per day)
            const dailyTrades = {};
            trades.forEach(trade => {
                if (trade.date) {
                    dailyTrades[trade.date] = (dailyTrades[trade.date] || 0) + 1;
                }
            });
            
            overtrading = Object.values(dailyTrades).filter(count => count > 5).length;
            
            // Emotional trades (very large wins/losses compared to average)
            const avgAbsPnL = trades.reduce((sum, t) => sum + Math.abs(t.pnl || 0), 0) / trades.length;
            emotionalTrades = trades.filter(t => Math.abs(t.pnl || 0) > avgAbsPnL * 3).length;
            
            // Calculate discipline score
            const totalNegativeIndicators = revengeTrading + overtrading + emotionalTrades;
            const disciplineScore = Math.max(0, 100 - (totalNegativeIndicators / trades.length * 100));
            
            return {
                revengeTrading,
                overtrading,
                emotionalTrades,
                disciplineScore
            };
        }

        function generateRecommendations(analysis) {
            const recommendations = [];
            const { performance, risk, strategies, symbols, psychology } = analysis;
            
            // Performance recommendations
            if (performance.winRate < 50) {
                recommendations.push({
                    priority: 'high',
                    title: 'Verbesser deine Erfolgsrate',
                    text: `Mit ${performance.winRate.toFixed(1)}% Winrate solltest du deine Entry-Kriterien √ºberdenken. Warte auf bessere Setups.`,
                    icon: 'üéØ'
                });
            }
            
            if (performance.riskRewardRatio < 1.5) {
                recommendations.push({
                    priority: 'high',
                    title: 'Optimiere Risk/Reward-Verh√§ltnis',
                    text: `Aktuell 1:${performance.riskRewardRatio.toFixed(1)}. Lass Gewinne l√§nger laufen oder setze engere Stop-Loss.`,
                    icon: '‚öñÔ∏è'
                });
            }
            
            // Risk recommendations
            if (risk.maxLossStreak > 5) {
                recommendations.push({
                    priority: 'high',
                    title: 'Reduziere Verlustserien',
                    text: `${risk.maxLossStreak} aufeinanderfolgende Verluste sind zu viel. Pausiere nach 3 Verlusten.`,
                    icon: 'üõë'
                });
            }
            
            if (risk.maxLoss > 10) {
                recommendations.push({
                    priority: 'medium',
                    title: 'Begrenze Einzelverluste',
                    text: `${risk.maxLoss.toFixed(1)}% Einzelverlust ist zu hoch. Setze ein Maximum von 5% pro Trade.`,
                    icon: 'üîí'
                });
            }
            
            // Strategy recommendations
            if (strategies.length > 1) {
                const bestStrategy = strategies[0];
                const worstStrategy = strategies[strategies.length - 1];
                
                if (bestStrategy.totalPnL > 0 && worstStrategy.totalPnL < 0) {
                    recommendations.push({
                        priority: 'medium',
                        title: 'Fokussiere auf erfolgreiche Strategien',
                        text: `"${bestStrategy.name}" (+${bestStrategy.totalPnL.toFixed(1)}%) vs "${worstStrategy.name}" (${worstStrategy.totalPnL.toFixed(1)}%)`,
                        icon: 'üé™'
                    });
                }
            }
            
            // Psychology recommendations
            if (psychology.disciplineScore < 70) {
                recommendations.push({
                    priority: 'medium',
                    title: 'Arbeite an deiner Disziplin',
                    text: `Disziplin-Score: ${psychology.disciplineScore.toFixed(0)}%. Vermeide emotionales Trading.`,
                    icon: 'üß†'
                });
            }
            
            // Diversification recommendations
            if (symbols.diversificationScore < 30) {
                recommendations.push({
                    priority: 'low',
                    title: 'Diversifiziere deine Trades',
                    text: 'Trade verschiedene Symbole um das Risiko zu streuen.',
                    icon: 'üåç'
                });
            }
            
            // Positive reinforcement
            if (performance.winRate > 70) {
                recommendations.push({
                    priority: 'low',
                    title: 'Exzellente Erfolgsrate!',
                    text: `${performance.winRate.toFixed(1)}% Winrate ist hervorragend. Halte deine Strategie bei.`,
                    icon: 'üéâ'
                });
            }
            
            return recommendations;
        }

        function generateComprehensiveAnalysisHTML(analysis) {
            const { performance, risk, strategies, symbols, timeAnalysis, psychology, recommendations } = analysis;
            
            return `
                <!-- Performance Analysis -->
                <div class="analysis-category performance">
                    <div class="category-header">
                        <span>üìà</span>
                        <span>Performance-Analyse</span>
                    </div>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Winrate</div>
                            <div class="metric-value ${performance.winRate >= 60 ? 'positive' : performance.winRate >= 40 ? 'neutral' : 'negative'}">
                                ${performance.winRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Profit Factor</div>
                            <div class="metric-value ${performance.profitFactor >= 1.5 ? 'positive' : performance.profitFactor >= 1 ? 'neutral' : 'negative'}">
                                ${performance.profitFactor.toFixed(1)}
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Risk/Reward</div>
                            <div class="metric-value ${performance.riskRewardRatio >= 1.5 ? 'positive' : performance.riskRewardRatio >= 1 ? 'neutral' : 'negative'}">
                                1:${performance.riskRewardRatio.toFixed(1)}
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Max Drawdown</div>
                            <div class="metric-value ${performance.maxDrawdown <= 10 ? 'positive' : performance.maxDrawdown <= 20 ? 'neutral' : 'negative'}">
                                ${performance.maxDrawdown.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Konsistenz-Score</span>
                            <span>${performance.consistencyScore.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getScoreClass(performance.consistencyScore)}" 
                                 style="width: ${performance.consistencyScore}%"></div>
                        </div>
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="analysis-category risk">
                    <div class="category-header">
                        <span>üõ°Ô∏è</span>
                        <span>Risiko-Management</span>
                    </div>
                    <ul class="insight-list">
                        <li class="insight-item">
                            <span class="insight-icon">üìâ</span>
                            <span class="insight-text">L√§ngste Verlustserie: <strong>${risk.maxLossStreak} Trades</strong></span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-icon">üìà</span>
                            <span class="insight-text">L√§ngste Gewinnserie: <strong>${risk.maxWinStreak} Trades</strong></span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-icon">üí∏</span>
                            <span class="insight-text">Gr√∂√üter Einzelverlust: <strong>${risk.maxLoss.toFixed(1)}%</strong></span>
                        </li>
                    </ul>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Risiko-Score</span>
                            <span>${risk.riskScore.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getScoreClass(risk.riskScore)}" 
                                 style="width: ${risk.riskScore}%"></div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Analysis -->
                <div class="analysis-category strategy">
                    <div class="category-header">
                        <span>üé™</span>
                        <span>Strategie-Analyse</span>
                    </div>
                    ${strategies.slice(0, 3).map(strategy => `
                        <div class="insight-item">
                            <span class="insight-icon">${strategy.totalPnL >= 0 ? '‚úÖ' : '‚ùå'}</span>
                            <span class="insight-text">
                                <strong>${strategy.name}</strong>: ${strategy.totalPnL >= 0 ? '+' : ''}${strategy.totalPnL.toFixed(1)}% 
                                (${strategy.totalTrades} Trades, ${strategy.winRate.toFixed(0)}% Winrate)
                            </span>
                        </div>
                    `).join('')}
                </div>

                <!-- Psychology Analysis -->
                <div class="analysis-category psychology">
                    <div class="category-header">
                        <span>üß†</span>
                        <span>Trading-Psychologie</span>
                    </div>
                    <ul class="insight-list">
                        <li class="insight-item">
                            <span class="insight-icon">${psychology.revengeTrading === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span class="insight-text">Revenge Trading: <strong>${psychology.revengeTrading} F√§lle</strong></span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-icon">${psychology.overtrading === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span class="insight-text">Overtrading Tage: <strong>${psychology.overtrading}</strong></span>
                        </li>
                        <li class="insight-item">
                            <span class="insight-icon">${psychology.emotionalTrades <= 2 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span class="insight-text">Emotionale Trades: <strong>${psychology.emotionalTrades}</strong></span>
                        </li>
                    </ul>
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Disziplin-Score</span>
                            <span>${psychology.disciplineScore.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${getScoreClass(psychology.disciplineScore)}" 
                                 style="width: ${psychology.disciplineScore}%"></div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="analysis-category recommendations">
                    <div class="category-header">
                        <span>üí°</span>
                        <span>Handlungsempfehlungen</span>
                    </div>
                    ${recommendations.map(rec => `
                        <div class="recommendation-item ${rec.priority}">
                            <div class="recommendation-title">
                                ${rec.icon} ${rec.title}
                            </div>
                            <div class="recommendation-text">
                                ${rec.text}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getScoreClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'average';
            return 'poor';
        }

        async function loadTrades() {
            const snapshot = await tradesRef.get();
            const trades = [];
            tbody.innerHTML = "";

            snapshot.forEach(doc => {
                const trade = doc.data();
                trade.id = doc.id;
                trades.push(trade);
            });

            // ‚úÖ Sortiere nach Datum (neueste zuerst)
            trades.sort((a, b) => {
                const [dayA, monthA, yearA] = (a.date || '01-01-1970').split("-").map(Number);
                const [dayB, monthB, yearB] = (b.date || '01-01-1970').split("-").map(Number);
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateB - dateA;
            });

            allTrades = trades;

            trades.forEach(trade => {
                const pnlClass = trade.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const row = document.createElement("tr");

                row.innerHTML = `
                <td>${trade.date || ''}</td>
                <td>${trade.symbol || ''}</td>
                <td class="direction ${trade.direction?.toLowerCase() || ''}">${trade.direction || ''}</td>
                <td><a href="${trade.entryScreenshot || '#'}" target="_blank">üì∏</a></td>
                <td><a href="${trade.exitScreenshot || '#'}" target="_blank">üì∏</a></td>
                <td class="result result-${trade.result?.toLowerCase() || ''}">${trade.result || ''}</td>
                <td class="${pnlClass}">${trade.pnl >= 0 ? '+' : ''}${trade.pnl ?? ''}%</td>
                <td>${trade.strategy || ''}</td>
                <td>
                    <button class="note-btn" data-id="${trade.id}">üìù</button>
                    <button class="edit-btn" data-id="${trade.id}">‚úèÔ∏è</button>
                    <button class="delete-btn" data-id="${trade.id}">üóëÔ∏è</button>
                </td>
                `;
                tbody.appendChild(row);

                row.querySelector(".delete-btn").addEventListener("click", () => deleteTrade(trade.id));
                row.querySelector(".note-btn").addEventListener("click", () => openNoteModal(trade.id, trade.note || ""));
                row.querySelector(".edit-btn").addEventListener("click", () => startEdit(trade));
            });

            updateStatistics(trades);
            updateCharts(trades);
        }

        function updateStatistics(trades) {
            const totalPnL = trades.reduce((sum, t) => sum + (t.pnl || 0), 0).toFixed(2);
            
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => (t.pnl || 0) > 0);
            const losingTrades = trades.filter(t => (t.pnl || 0) < 0);
            const winRate = totalTrades > 0 ? ((winningTrades.length / totalTrades) * 100).toFixed(1) : 0;
            
            const avgWin = winningTrades.length > 0 ? 
                (winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length).toFixed(2) : 0;
            const avgLoss = losingTrades.length > 0 ? 
                (losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length).toFixed(2) : 0;
            
            const bestTrade = trades.length > 0 ? Math.max(...trades.map(t => t.pnl || 0)).toFixed(2) : 0;
            const worstTrade = trades.length > 0 ? Math.min(...trades.map(t => t.pnl || 0)).toFixed(2) : 0;
            
            document.getElementById("totalTrades").textContent = totalTrades;
            document.getElementById("winRate").textContent = `${winRate}%`;
            document.getElementById("totalPnL").textContent = `${totalPnL}%`;
            document.getElementById("totalPnL").className = totalPnL >= 0 ? 'value positive' : 'value negative';
            document.getElementById("avgWin").textContent = `+${avgWin}%`;
            document.getElementById("avgLoss").textContent = `${avgLoss}%`;
            document.getElementById("bestTrade").textContent = `+${bestTrade}%`;
            document.getElementById("worstTrade").textContent = `${worstTrade}%`;
        }

        function updateCharts(trades) {
            if (trades.length === 0) return;
            
            // Zerst√∂re existierende Charts
            [pnlChart, resultsChart, strategyChart].forEach(chart => {
                if (chart) chart.destroy();
            });
            
            updatePnLChart(trades);
            updateResultsChart(trades);
            updateStrategyChart(trades);
            updateSymbolPerformanceList(trades);
        }

        function updatePnLChart(trades) {
            if (trades.length === 0) {
                const ctx = document.getElementById('pnlChart').getContext('2d');
                if (pnlChart) pnlChart.destroy();
                return;
            }

            // Sortiere Trades chronologisch (√§lteste zuerst) f√ºr kumulativen PnL
            const sortedTrades = [...trades].sort((a, b) => {
                const [dayA, monthA, yearA] = (a.date || '01-01-1970').split("-").map(Number);
                const [dayB, monthB, yearB] = (b.date || '01-01-1970').split("-").map(Number);
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB; // √Ñlteste zuerst
            });

            let cumulativePnL = 0;
            const data = [];
            const labels = [];

            sortedTrades.forEach((trade, index) => {
                cumulativePnL += trade.pnl || 0;
                data.push(cumulativePnL);
                
                // Erstelle aussagekr√§ftige Labels
                const symbol = trade.symbol || 'Trade';
                const shortDate = trade.date ? trade.date.substring(0, 5) : `#${index + 1}`;
                labels.push(`${symbol} (${shortDate})`);
            });

            const finalPnL = data[data.length - 1] || 0;

            const ctx = document.getElementById('pnlChart').getContext('2d');
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kumulativer PnL',
                        data: data,
                        borderColor: finalPnL >= 0 ? '#10b981' : '#ef4444',
                        backgroundColor: finalPnL >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: data.map(value => value >= 0 ? '#10b981' : '#ef4444'),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        segment: {
                            borderColor: function(ctx) {
                                // F√§rbe Linien-Segmente basierend auf Richtung
                                const currentValue = ctx.p1.parsed.y;
                                const previousValue = ctx.p0.parsed.y;
                                return currentValue >= previousValue ? '#10b981' : '#ef4444';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const trade = sortedTrades[index];
                                    return `${trade.symbol || 'Trade'} (${trade.date || 'N/A'})`;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const trade = sortedTrades[index];
                                    const tradePnL = trade.pnl || 0;
                                    const cumulativePnL = context.parsed.y;
                                    
                                    return [
                                        `Trade PnL: ${tradePnL >= 0 ? '+' : ''}${tradePnL.toFixed(2)}%`,
                                        `Kumulativ: ${cumulativePnL >= 0 ? '+' : ''}${cumulativePnL.toFixed(2)}%`,
                                        `Strategie: ${trade.strategy || 'N/A'}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1
                            },
                            ticks: { 
                                font: { size: 10 },
                                color: '#6b7280',
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + value.toFixed(1) + '%';
                                }
                            },
                            // Zero-Linie hervorheben
                            beforeDraw: function(chart) {
                                const ctx = chart.ctx;
                                const yAxis = chart.scales.y;
                                const zeroY = yAxis.getPixelForValue(0);
                                
                                ctx.save();
                                ctx.strokeStyle = '#374151';
                                ctx.lineWidth = 1;
                                ctx.setLineDash([5, 5]);
                                ctx.beginPath();
                                ctx.moveTo(chart.chartArea.left, zeroY);
                                ctx.lineTo(chart.chartArea.right, zeroY);
                                ctx.stroke();
                                ctx.restore();
                            }
                        },
                        x: { 
                            grid: {
                                display: false
                            },
                            ticks: { 
                                font: { size: 9 },
                                color: '#6b7280',
                                maxTicksLimit: 5,
                                callback: function(value, index) {
                                    const trade = sortedTrades[index];
                                    if (!trade) return '';
                                    // Zeige nur Symbol f√ºr bessere Lesbarkeit
                                    return trade.symbol || `#${index + 1}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateResultsChart(trades) {
            const results = trades.reduce((acc, trade) => {
                const result = trade.result || 'Unbekannt';
                acc[result] = (acc[result] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(results);
            const data = Object.values(results);
            const colors = {
                'TP': '#10b981',
                'BE': '#3b82f6', 
                'SL': '#ef4444',
                'Unbekannt': '#6b7280'
            };

            const ctx = document.getElementById('resultsChart').getContext('2d');
            resultsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(label => colors[label] || '#6b7280'),
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: { 
                                font: { size: 9 },
                                color: '#1a202c',
                                padding: 8,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateStrategyChart(trades) {
            const strategies = trades.reduce((acc, trade) => {
                const strategy = trade.strategy || 'Keine Strategie';
                if (!acc[strategy]) {
                    acc[strategy] = { total: 0, pnl: 0 };
                }
                acc[strategy].total += 1;
                acc[strategy].pnl += trade.pnl || 0;
                return acc;
            }, {});

            // Sortiere Strategien nach PnL
            const sortedStrategies = Object.entries(strategies)
                .map(([name, data]) => ({
                    name: name.length > 12 ? name.substring(0, 12) + '...' : name,
                    fullName: name,
                    avgPnL: (data.pnl / data.total),
                    total: data.total
                }))
                .sort((a, b) => b.avgPnL - a.avgPnL)
                .slice(0, 6); // Nur die besten 6 Strategien anzeigen

            const labels = sortedStrategies.map(s => s.name);
            const data = sortedStrategies.map(s => s.avgPnL);
            const colors = data.map(value => value >= 0 ? '#10b981' : '#ef4444');

            const ctx = document.getElementById('strategyChart').getContext('2d');
            strategyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '√ò PnL pro Trade',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 6,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return sortedStrategies[index].fullName;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const strategy = sortedStrategies[index];
                                    return [
                                        `√ò PnL: ${context.parsed.x.toFixed(2)}%`,
                                        `Trades: ${strategy.total}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1
                            },
                            ticks: { 
                                font: { size: 9 },
                                color: '#6b7280',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y: { 
                            grid: {
                                display: false
                            },
                            ticks: { 
                                font: { size: 9 },
                                color: '#6b7280'
                            }
                        }
                    }
                }
            });
        }

        function updateSymbolPerformanceList(trades) {
            const symbolStats = trades.reduce((acc, trade) => {
                const symbol = trade.symbol || 'Unbekannt';
                if (!acc[symbol]) {
                    acc[symbol] = { wins: 0, total: 0, totalPnl: 0 };
                }
                acc[symbol].total += 1;
                acc[symbol].totalPnl += trade.pnl || 0;
                if ((trade.pnl || 0) > 0) {
                    acc[symbol].wins += 1;
                }
                return acc;
            }, {});

            const symbolData = Object.entries(symbolStats)
                .map(([symbol, stats]) => ({
                    symbol,
                    winrate: stats.total > 0 ? (stats.wins / stats.total * 100) : 0,
                    total: stats.total,
                    totalPnl: stats.totalPnl,
                    avgPnl: stats.total > 0 ? stats.totalPnl / stats.total : 0
                }))
                .filter(s => s.total >= 1)
                .sort((a, b) => b.totalPnl - a.totalPnl)
                .slice(0, 15); // Zeige nur die besten 15 Symbole

            const container = document.getElementById('symbolPerformanceList');
            container.innerHTML = '';

            if (symbolData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280; font-size: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;">üìä</div>
                        <p>Noch keine Trades vorhanden</p>
                    </div>
                `;
                return;
            }

            // Header hinzuf√ºgen
            const header = document.createElement('div');
            header.style.cssText = `
                display: grid;
                grid-template-columns: 1fr 50px 40px 30px;
                gap: 8px;
                padding: 8px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 6px;
                margin-bottom: 8px;
                font-size: 10px;
                font-weight: 600;
                color: #374151;
                text-align: center;
            `;
            header.innerHTML = `
                <div style="text-align: left;">Symbol</div>
                <div>PnL</div>
                <div>Win%</div>
                <div>Qty</div>
            `;
            container.appendChild(header);

            symbolData.forEach((data, index) => {
                const item = document.createElement('div');
                item.className = 'symbol-item-mini';
                item.style.cssText = `
                    display: grid;
                    grid-template-columns: 1fr 50px 40px 30px;
                    gap: 8px;
                    align-items: center;
                    padding: 6px 8px;
                    margin-bottom: 3px;
                    background: rgba(255, 255, 255, 0.7);
                    border-radius: 6px;
                    font-size: 11px;
                    border-left: 3px solid ${data.totalPnl >= 0 ? '#10b981' : '#ef4444'};
                    transition: all 0.2s ease;
                `;

                // Hover-Effekt
                item.addEventListener('mouseenter', () => {
                    item.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
                    item.style.transform = 'translateX(2px)';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                    item.style.transform = 'translateX(0)';
                });

                const pnlClass = data.totalPnl >= 0 ? 'positive' : 'negative';
                const winrateColor = data.winrate >= 70 ? '#10b981' : data.winrate >= 50 ? '#f59e0b' : '#ef4444';

                item.innerHTML = `
                    <div style="font-weight: 600; color: #667eea; text-align: left;">
                        ${data.symbol}
                    </div>
                    <div style="font-weight: 600; color: ${data.totalPnl >= 0 ? '#10b981' : '#ef4444'}; text-align: center;">
                        ${data.totalPnl >= 0 ? '+' : ''}${data.totalPnl.toFixed(1)}%
                    </div>
                    <div style="font-weight: 500; color: ${winrateColor}; text-align: center;">
                        ${data.winrate.toFixed(0)}%
                    </div>
                    <div style="font-weight: 500; color: #6b7280; text-align: center;">
                        ${data.total}
                    </div>
                `;

                // Tooltip f√ºr zus√§tzliche Info
                item.title = `${data.symbol}\nGesamter PnL: ${data.totalPnl.toFixed(2)}%\nDurchschnitt pro Trade: ${data.avgPnl.toFixed(2)}%\nWinrate: ${data.winrate.toFixed(1)}%\nAnzahl Trades: ${data.total}`;

                container.appendChild(item);
            });

            // Scrollbar f√ºr bessere UX
            container.style.scrollBehavior = 'smooth';
        }

        async function deleteTrade(id) {
            await tradesRef.doc(id).delete();
            loadTrades();
        }

        function formatDate(isoDateStr) {
            if (!isoDateStr) return '';
            const [year, month, day] = isoDateStr.split("-");
            return `${day}-${month}-${year}`;
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const trade = {
                date: formatDate(document.getElementById("date").value) || '',
                symbol: document.getElementById("symbol").value || '',
                direction: document.getElementById("direction").value || '',
                entryScreenshot: document.getElementById("entryScreenshot").value || '',
                exitScreenshot: document.getElementById("exitScreenshot").value || '',
                result: document.getElementById("result").value || '',
                pnl: parseFloat(document.getElementById("pnl").value) || 0,
                strategy: document.getElementById("strategy").value || '',
                note: ""
            };

            if (editingTradeId) {
                await tradesRef.doc(editingTradeId).update(trade);
                editingTradeId = null;
                form.classList.remove("editing");
                editIndicator.style.display = "none";
            } else {
                await tradesRef.add(trade);
            }

            form.reset();
            loadTrades();
        });

        function toISODate(dateStr) {
            const [day, month, year] = dateStr.split("-");
            return `${year}-${month}-${day}`;
        }

        function startEdit(trade) {
            document.getElementById("date").value = toISODate(trade.date || '');
            document.getElementById("symbol").value = trade.symbol || '';
            document.getElementById("direction").value = trade.direction || '';
            document.getElementById("entryScreenshot").value = trade.entryScreenshot || '';
            document.getElementById("exitScreenshot").value = trade.exitScreenshot || '';
            document.getElementById("result").value = trade.result || '';
            document.getElementById("pnl").value = trade.pnl ?? '';
            document.getElementById("strategy").value = trade.strategy || '';

            editingTradeId = trade.id;
            form.classList.add("editing");
            editIndicator.style.display = "block";
        }

        function openNoteModal(id, note) {
            currentNoteId = id;
            document.getElementById("noteInput").value = note;
            document.getElementById("noteModal").classList.remove("hidden");
        }

        function closeNoteModal() {
            document.getElementById("noteModal").classList.add("hidden");
        }

        async function saveNote() {
            const note = document.getElementById("noteInput").value;
            if (currentNoteId) {
                await tradesRef.doc(currentNoteId).update({ note });
            }
            closeNoteModal();
            loadTrades();
        }

        // Analysis button event listener
        document.getElementById('generateAnalysisBtn').addEventListener('click', () => {
            const button = document.getElementById('generateAnalysisBtn');
            const originalText = button.innerHTML;
            
            button.innerHTML = '‚è≥ Analysiere...';
            button.disabled = true;
            
            setTimeout(() => {
                generateComprehensiveAnalysis(allTrades);
                button.innerHTML = '‚úÖ Analyse abgeschlossen!';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }, 1500);
        });

        loadTrades();
    </script>
</body>
</html>