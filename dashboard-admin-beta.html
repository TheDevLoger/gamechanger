<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-header {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .dashboard-header p {
            color: #6b7280;
            font-size: 1.125rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.25rem;
        }

        .stat-value.positive {
            color: var(--success-color);
        }

        .stat-value.negative {
            color: var(--danger-color);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-section {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            box-shadow: var(--shadow);
        }

        .user-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .activity-list {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .activity-type {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity-type.arbeit {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .activity-type.sport {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
        }

        .activity-type.protokoll {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .activity-duration {
            font-weight: 600;
            color: var(--dark-color);
        }

        .loading {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logout-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .analysis-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            margin: 0 0.5rem;
        }

        .analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .enhanced-analysis-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            margin: 0 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .enhanced-analysis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .enhanced-analysis-btn:hover::before {
            left: 100%;
        }

        .enhanced-analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 2000;
        }

        .analysis-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .analysis-content {
            background: white;
            border-radius: var(--radius);
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .analysis-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analysis-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .analysis-close:hover {
            background: var(--border-color);
            color: var(--dark-color);
        }

        .analysis-body {
            padding: 2rem;
        }

        .analysis-section {
            margin-bottom: 2rem;
        }

        .analysis-section h3 {
            font-size: 1.375rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .insight-card {
            background: var(--light-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .insight-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .insight-description {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--light-color);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .recommendation-list li:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .recommendation-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .recommendation-text {
            flex: 1;
            line-height: 1.5;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .activity-dropdown-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .dropdown-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .dropdown-header:hover {
            background: var(--light-color);
        }

        .dropdown-arrow {
            transition: transform 0.3s ease;
            font-weight: bold;
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .dropdown-content.show {
            max-height: 600px;
        }

        .dropdown-controls {
            padding: 1rem 1.5rem;
            display: flex;
            gap: 1rem;
            background: var(--light-color);
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-controls select,
        .dropdown-controls input {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }

        .all-activities-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem 1.5rem;
        }

        /* Enhanced Analysis Specific Styles */
        .enhanced-analysis-body {
            max-width: 1200px;
            width: 100%;
        }

        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.875rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .heatmap-container {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 1rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .productivity-score {
            text-align: center;
            margin: 2rem 0;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0deg, var(--secondary-color) 180deg, var(--border-color) 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
        }

        .score-circle::before {
            content: '';
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            z-index: 1;
        }

        .ai-insights {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius);
            margin: 2rem 0;
        }

        .ai-insights h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .prediction-chart {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .user-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .logout-btn {
                bottom: 1rem;
                right: 1rem;
                padding: 0.75rem 1.5rem;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .analysis-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <p>√úbersicht √ºber alle Aktivit√§ten und Zeiten</p>
        </div>

        <!-- Benutzer A Section -->
        <div class="user-section">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar">EL</div>
                    <div>
                        <div class="user-name">Erik L√§hner</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Trading & Gamedev</div>
                    </div>
                </div>
            </div>

            <!-- Individual Stats for User A -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="totalHoursA">0</div>
                    <div class="stat-label">Gesamtstunden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="avgDailyA">0</div>
                    <div class="stat-label">√ò Stunden/Tag</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="productivityA">0%</div>
                    <div class="stat-label">Produktivit√§t</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="streakA">0</div>
                    <div class="stat-label">Tage in Folge</div>
                </div>
            </div>

            <!-- Analysis Buttons -->
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <button class="analysis-btn" onclick="showIntelligentAnalysis('A', 'Erik L√§hner')">
                    üß† Intelligente Datenauswertung
                </button>
                <button class="enhanced-analysis-btn" onclick="showEnhancedAnalysis('A', 'Erik L√§hner')">
                    üöÄ Erweiterte KI-Analyse
                </button>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Zeitverteilung</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChartA"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Wochenverlauf</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="lineChartA"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üéØ Tagesvergleich</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="barChartA"></canvas>
                    </div>
                </div>

                <div class="activity-list">
                    <h3 class="chart-title" style="margin-bottom: 1rem;">üìÖ Letzte Aktivit√§ten</h3>
                    <div id="activitiesA">
                        <div class="loading"></div>
                    </div>
                </div>

                <div class="activity-dropdown-card">
                    <div class="dropdown-header" onclick="toggleAllActivities('A')">
                        <h3 class="chart-title">üìã Alle Aktivit√§ten</h3>
                        <div class="dropdown-arrow" id="dropdownArrowA">‚ñº</div>
                    </div>
                    <div class="dropdown-content" id="allActivitiesA">
                        <div class="dropdown-controls">
                            <select id="filterTypeA" onchange="filterActivities('A')">
                                <option value="all">Alle Aktivit√§ten</option>
                                <option value="arbeit">Nur Trading</option>
                                <option value="sport">Nur Gamedev</option>
                            </select>
                            <input type="date" id="filterDateA" onchange="filterActivities('A')" placeholder="Datum filtern">
                        </div>
                        <div class="all-activities-list" id="allActivitiesListA">
                            <div class="loading"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Benutzer B Section -->
        <div class="user-section">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" style="background: linear-gradient(135deg, var(--success-color), #059669);">ET</div>
                    <div>
                        <div class="user-name">Eric Tamme</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Trading & Workout</div>
                    </div>
                </div>
            </div>

            <!-- Individual Stats for User B -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="totalHoursB">0</div>
                    <div class="stat-label">Gesamtstunden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="avgDailyB">0</div>
                    <div class="stat-label">√ò Stunden/Tag</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="productivityB">0%</div>
                    <div class="stat-label">Produktivit√§t</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="streakB">0</div>
                    <div class="stat-label">Tage in Folge</div>
                </div>
            </div>

            <!-- Analysis Buttons -->
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <button class="analysis-btn" onclick="showIntelligentAnalysis('B', 'Eric Tamme')">
                    üß† Intelligente Datenauswertung
                </button>
                <button class="enhanced-analysis-btn" onclick="showEnhancedAnalysis('B', 'Eric Tamme')">
                    üöÄ Erweiterte KI-Analyse
                </button>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Zeitverteilung</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChartB"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Wochenverlauf</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="lineChartB"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üéØ Tagesvergleich</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="barChartB"></canvas>
                    </div>
                </div>

                <div class="activity-list">
                    <h3 class="chart-title" style="margin-bottom: 1rem;">üìÖ Letzte Aktivit√§ten</h3>
                    <div id="activitiesB">
                        <div class="loading"></div>
                    </div>
                </div>

                <div class="activity-dropdown-card">
                    <div class="dropdown-header" onclick="toggleAllActivities('B')">
                        <h3 class="chart-title">üìã Alle Aktivit√§ten</h3>
                        <div class="dropdown-arrow" id="dropdownArrowB">‚ñº</div>
                    </div>
                    <div class="dropdown-content" id="allActivitiesB">
                        <div class="dropdown-controls">
                            <select id="filterTypeB" onchange="filterActivities('B')">
                                <option value="all">Alle Aktivit√§ten</option>
                                <option value="arbeit">Nur Trading</option>
                                <option value="sport">Nur Workout</option>
                            </select>
                            <input type="date" id="filterDateB" onchange="filterActivities('B')" placeholder="Datum filtern">
                        </div>
                        <div class="all-activities-list" id="allActivitiesListB">
                            <div class="loading"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="logout-btn" onclick="logout()">
        <span>üîí</span>
        <span>Logout</span>
    </button>

    <!-- Analysis Modal -->
    <div class="analysis-modal" id="analysisModal">
        <div class="analysis-content">
            <div class="analysis-header">
                <div>
                    <h2 id="analysisTitle">üß† Intelligente Datenauswertung</h2>
                    <p id="analysisSubtitle">Lade Analyse...</p>
                </div>
                <button class="analysis-close" onclick="closeAnalysis()">√ó</button>
            </div>
            <div class="analysis-body" id="analysisBody">
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">Analysiere Daten...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Analysis Modal -->
    <div class="analysis-modal" id="enhancedAnalysisModal">
        <div class="analysis-content">
            <div class="analysis-header">
                <div>
                    <h2 id="enhancedAnalysisTitle">üöÄ Erweiterte KI-Analyse</h2>
                    <p id="enhancedAnalysisSubtitle">F√ºhre tiefgehende Analyse durch...</p>
                </div>
                <button class="analysis-close" onclick="closeEnhancedAnalysis()">√ó</button>
            </div>
            <div class="enhanced-analysis-body" id="enhancedAnalysisBody">
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">F√ºhre erweiterte KI-Analyse durch...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            doc,
            getDoc,
            getDocs,
            collection
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAujeUok4jKYwnr5GEXze_EadszqMdY1y4",
            authDomain: "gamechanger-78fb4.firebaseapp.com",
            projectId: "gamechanger-78fb4",
            storageBucket: "gamechanger-78fb4.firebasestorage.app",
            messagingSenderId: "510513691722",
            appId: "1:510513691722:web:c0c1a97141ddfda4377ab3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // Chart.js Defaults
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.padding = 20;
        Chart.defaults.plugins.legend.labels.usePointStyle = true;

        // Farben f√ºr Charts
        const colors = {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6'
        };

        // Global data storage for analysis
        let userData = {};
        let userActivities = {};
        let allUserActivities = {}; // Store all activities for dropdown

        // Store user data for analysis
        function storeUserData(suffix, data) {
            userData[suffix] = {
                ...data,
                analysisTimestamp: Date.now()
            };
        }

        // Store user activities for deeper analysis
        function storeUserActivities(suffix, activities) {
            userActivities[suffix] = activities;
        }

        // Store all user activities for dropdown
        function storeAllUserActivities(suffix, activities) {
            allUserActivities[suffix] = activities;
        }

        // Configuration - Set to true to use demo data for testing
        const USE_DEMO_DATA = false; // Change to false for real Firebase data

        // Auth Check with better error handling
        onAuthStateChanged(auth, user => {
            console.log("Auth state changed:", user ? "User logged in" : "No user");
            
            if (USE_DEMO_DATA) {
                console.log("Using demo data for testing...");
                loadDemoData();
                return;
            }
            
            if (!user) {
                console.log("No user found, redirecting to login...");
                alert("Bitte zuerst einloggen.");
                window.location.href = 'index.html';
                return;
            } else {
                console.log("User authenticated, loading data...");
                loadAllData();
            }
        });

        // Demo data for testing
        function loadDemoData() {
            console.log("Loading demo data...");
            
            const demoDataA = {
                zeiten: { protokoll: 15.5, arbeit: 45.2, sport: 28.3 },
                weekData: {
                    'Mo': { protokoll: 2.1, arbeit: 6.5, sport: 4.2 },
                    'Di': { protokoll: 2.3, arbeit: 7.1, sport: 3.8 },
                    'Mi': { protokoll: 1.9, arbeit: 6.8, sport: 4.5 },
                    'Do': { protokoll: 2.5, arbeit: 7.3, sport: 4.1 },
                    'Fr': { protokoll: 2.2, arbeit: 6.9, sport: 3.9 },
                    'Sa': { protokoll: 2.1, arbeit: 5.8, sport: 4.2 },
                    'So': { protokoll: 2.4, arbeit: 4.8, sport: 3.6 }
                },
                activities: [
                    { date: '2025-01-23', type: 'arbeit', dauer: 7.2, beschreibung: 'Trading Session - EUR/USD Analysis' },
                    { date: '2025-01-23', type: 'sport', dauer: 1.5, beschreibung: 'Game Development - Unity Scripting' },
                    { date: '2025-01-22', type: 'arbeit', dauer: 6.8, beschreibung: 'Market Research und Strategy' },
                    { date: '2025-01-22', type: 'protokoll', dauer: 0.5, beschreibung: 'Daily Review' },
                    { date: '2025-01-21', type: 'sport', dauer: 2.0, beschreibung: 'Game Testing und Bug Fixes' }
                ],
                allActivities: [
                    { date: '2025-01-23', type: 'arbeit', dauer: 7.2, beschreibung: 'Trading Session - EUR/USD Analysis' },
                    { date: '2025-01-23', type: 'sport', dauer: 1.5, beschreibung: 'Game Development - Unity Scripting' },
                    { date: '2025-01-22', type: 'arbeit', dauer: 6.8, beschreibung: 'Market Research und Strategy' },
                    { date: '2025-01-22', type: 'protokoll', dauer: 0.5, beschreibung: 'Daily Review' },
                    { date: '2025-01-21', type: 'sport', dauer: 2.0, beschreibung: 'Game Testing und Bug Fixes' },
                    { date: '2025-01-21', type: 'arbeit', dauer: 6.5, beschreibung: 'Forex Analysis' },
                    { date: '2025-01-20', type: 'protokoll', dauer: 0.8, beschreibung: 'Weekly Planning' }
                ],
                allDates: ['2025-01-23', '2025-01-22', '2025-01-21', '2025-01-20', '2025-01-19'],
                totalHours: 89.0,
                avgDaily: 17.8
            };

            const demoDataB = {
                zeiten: { protokoll: 12.3, arbeit: 52.1, sport: 31.6 },
                weekData: {
                    'Mo': { protokoll: 1.8, arbeit: 7.2, sport: 4.5 },
                    'Di': { protokoll: 1.9, arbeit: 7.8, sport: 4.2 },
                    'Mi': { protokoll: 1.7, arbeit: 7.5, sport: 4.8 },
                    'Do': { protokoll: 1.8, arbeit: 8.1, sport: 4.3 },
                    'Fr': { protokoll: 2.0, arbeit: 7.6, sport: 4.1 },
                    'Sa': { protokoll: 1.6, arbeit: 6.9, sport: 5.2 },
                    'So': { protokoll: 1.5, arbeit: 6.0, sport: 4.5 }
                },
                activities: [
                    { date: '2025-01-23', type: 'arbeit', dauer: 8.1, beschreibung: 'Forex Trading - Gold Analysis' },
                    { date: '2025-01-23', type: 'sport', dauer: 1.8, beschreibung: 'Cardio Training' },
                    { date: '2025-01-22', type: 'arbeit', dauer: 7.5, beschreibung: 'Options Trading Strategy' },
                    { date: '2025-01-22', type: 'sport', dauer: 2.1, beschreibung: 'Strength Training' },
                    { date: '2025-01-21', type: 'protokoll', dauer: 0.7, beschreibung: 'Performance Review' }
                ],
                allActivities: [
                    { date: '2025-01-23', type: 'arbeit', dauer: 8.1, beschreibung: 'Forex Trading - Gold Analysis' },
                    { date: '2025-01-23', type: 'sport', dauer: 1.8, beschreibung: 'Cardio Training' },
                    { date: '2025-01-22', type: 'arbeit', dauer: 7.5, beschreibung: 'Options Trading Strategy' },
                    { date: '2025-01-22', type: 'sport', dauer: 2.1, beschreibung: 'Strength Training' },
                    { date: '2025-01-21', type: 'protokoll', dauer: 0.7, beschreibung: 'Performance Review' },
                    { date: '2025-01-21', type: 'arbeit', dauer: 7.8, beschreibung: 'Market Analysis' },
                    { date: '2025-01-20', type: 'sport', dauer: 1.9, beschreibung: 'HIIT Workout' }
                ],
                allDates: ['2025-01-23', '2025-01-22', '2025-01-21', '2025-01-20', '2025-01-19'],
                totalHours: 96.0,
                avgDaily: 19.2
            };

            // Store demo data
            storeUserData('A', demoDataA);
            storeUserActivities('A', demoDataA.activities);
            storeAllUserActivities('A', demoDataA.allActivities);

            storeUserData('B', demoDataB);
            storeUserActivities('B', demoDataB.activities);
            storeAllUserActivities('B', demoDataB.allActivities);

            // Create charts and display data
            createUserCharts('A', demoDataA);
            displayActivities('A', demoDataA.activities);
            displayAllActivities('A', demoDataA.allActivities);
            updateUserStats('A', demoDataA);

            createUserCharts('B', demoDataB);
            displayActivities('B', demoDataB.activities);
            displayAllActivities('B', demoDataB.allActivities);
            updateUserStats('B', demoDataB);

            console.log("Demo data loaded successfully!");
        }

        function toggleAllActivities(suffix) {
            const dropdown = document.getElementById(`allActivities${suffix}`);
            const arrow = document.getElementById(`dropdownArrow${suffix}`);
            
            if (!dropdown || !arrow) {
                console.error(`Dropdown elements not found for suffix ${suffix}`);
                return;
            }
            
            dropdown.classList.toggle('show');
            arrow.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function filterActivities(suffix) {
            const typeFilter = document.getElementById(`filterType${suffix}`).value;
            const dateFilter = document.getElementById(`filterDate${suffix}`).value;
            const allActivities = allUserActivities[suffix] || [];
            
            console.log(`Filtering activities for ${suffix}:`, { typeFilter, dateFilter, totalActivities: allActivities.length });
            
            let filteredActivities = allActivities;

            // Filter by type
            if (typeFilter !== 'all') {
                filteredActivities = filteredActivities.filter(activity => activity.type === typeFilter);
            }

            // Filter by date
            if (dateFilter) {
                filteredActivities = filteredActivities.filter(activity => activity.date === dateFilter);
            }

            console.log(`Filtered to ${filteredActivities.length} activities`);
            renderActivityList(suffix, filteredActivities);
        }

        // Intelligent Analysis Functions
        async function showIntelligentAnalysis(userSuffix, userName) {
            const modal = document.getElementById('analysisModal');
            const title = document.getElementById('analysisTitle');
            const subtitle = document.getElementById('analysisSubtitle');
            const body = document.getElementById('analysisBody');
            
            title.textContent = `üß† Intelligente Analyse f√ºr ${userName}`;
            subtitle.textContent = 'Analysiere Verhaltensmuster und erstelle Empfehlungen...';
            
            // Show loading state
            body.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">Analysiere Daten...</p>
                </div>
            `;
            
            modal.classList.add('show');
            
            // Simulate analysis delay for realistic feel
            setTimeout(() => {
                const analysis = generateIntelligentAnalysis(userSuffix, userName);
                body.innerHTML = analysis;
                subtitle.textContent = `Analyse abgeschlossen - ${new Date().toLocaleDateString('de-DE')}`;
            }, 2000);
        }

        // Enhanced Analysis Functions
        async function showEnhancedAnalysis(userSuffix, userName) {
            const modal = document.getElementById('enhancedAnalysisModal');
            const title = document.getElementById('enhancedAnalysisTitle');
            const subtitle = document.getElementById('enhancedAnalysisSubtitle');
            const body = document.getElementById('enhancedAnalysisBody');
            
            title.textContent = `üöÄ Erweiterte KI-Analyse f√ºr ${userName}`;
            subtitle.textContent = 'F√ºhre tiefgehende statistische Analyse durch...';
            
            // Show loading state
            body.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">F√ºhre erweiterte KI-Analyse durch...</p>
                    <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Analysiere Korrelationen, Trends und Vorhersagen...</p>
                </div>
            `;
            
            modal.classList.add('show');
            
            // Simulate analysis delay for realistic feel
            setTimeout(() => {
                const analysis = generateEnhancedAnalysis(userSuffix, userName);
                body.innerHTML = analysis;
                subtitle.textContent = `Erweiterte Analyse abgeschlossen - ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE')}`;
                
                // Initialize enhanced charts after content is loaded
                initializeEnhancedCharts(userSuffix);
            }, 3500);
        }

        function closeAnalysis() {
            document.getElementById('analysisModal').classList.remove('show');
        }

        function closeEnhancedAnalysis() {
            document.getElementById('enhancedAnalysisModal').classList.remove('show');
        }

        function generateIntelligentAnalysis(userSuffix, userName) {
            const data = userData[userSuffix] || {};
            const insights = analyzeUserData(data, userSuffix);
            
            return `
                <!-- Performance Overview -->
                <div class="analysis-section">
                    <h3>üìä Leistungs√ºberblick</h3>
                    <div class="analysis-grid">
                        <div class="insight-card">
                            <div class="insight-title">Gesamtaktivit√§t</div>
                            <div class="insight-value">${insights.totalHours.toFixed(1)}h</div>
                            <div class="insight-description">
                                ${insights.totalHours > 100 ? 'Sehr aktiv' : insights.totalHours > 50 ? 'Durchschnittlich aktiv' : 'Wenig aktiv'}
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">T√§glicher Durchschnitt</div>
                            <div class="insight-value">${insights.avgDaily.toFixed(1)}h</div>
                            <div class="insight-description">
                                ${insights.avgDaily > 6 ? '√úber dem Ziel' : insights.avgDaily > 4 ? 'Guter Durchschnitt' : 'Unter dem Ziel'}
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">Produktivit√§tstrend</div>
                            <div class="insight-value">${insights.productivity}%</div>
                            <div class="insight-description">
                                Tendenz: ${insights.trend.direction === 'up' ? 'üìà Steigend' : insights.trend.direction === 'down' ? 'üìâ Fallend' : '‚û°Ô∏è Stabil'}
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">Konsistenz</div>
                            <div class="insight-value">${insights.streak}</div>
                            <div class="insight-description">
                                Tage in Folge aktiv
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strengths and Weaknesses -->
                <div class="analysis-section">
                    <h3>üí™ St√§rken & Schw√§chen</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h4 style="color: var(--success-color); margin-bottom: 1rem;">‚úÖ St√§rken</h4>
                            <ul class="recommendation-list">
                                ${insights.strengths.map(strength => `
                                    <li style="border-left-color: var(--success-color);">
                                        <span class="recommendation-icon">üí™</span>
                                        <span class="recommendation-text">${strength}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: var(--danger-color); margin-bottom: 1rem;">‚ö†Ô∏è Verbesserungsbereiche</h4>
                            <ul class="recommendation-list">
                                ${insights.weaknesses.map(weakness => `
                                    <li style="border-left-color: var(--danger-color);">
                                        <span class="recommendation-icon">‚ö°</span>
                                        <span class="recommendation-text">${weakness}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Behavioral Patterns -->
                <div class="analysis-section">
                    <h3>üîç Verhaltensmuster</h3>
                    <div class="analysis-grid">
                        ${insights.patterns.map(pattern => `
                            <div class="insight-card">
                                <div class="insight-title">${pattern.title}</div>
                                <div class="insight-description">${pattern.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="analysis-section">
                    <h3>üöÄ Personalisierte Empfehlungen</h3>
                    <ul class="recommendation-list">
                        ${insights.recommendations.map(rec => `
                            <li>
                                <span class="recommendation-icon">${rec.icon}</span>
                                <div class="recommendation-text">
                                    <strong>${rec.title}</strong><br>
                                    ${rec.description}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <!-- Action Plan -->
                <div class="analysis-section">
                    <h3>üìã 30-Tage Aktionsplan</h3>
                    <div style="display: grid; gap: 1rem;">
                        ${insights.actionPlan.map((item, index) => `
                            <div class="insight-card">
                                <div class="insight-title">Woche ${index + 1}: ${item.title}</div>
                                <div class="insight-description">${item.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateEnhancedAnalysis(userSuffix, userName) {
            const data = userData[userSuffix] || {};
            const activities = userActivities[userSuffix] || [];
            const enhancedInsights = generateEnhancedInsights(data, activities, userSuffix);
            
            return `
                <!-- AI Performance Score -->
                <div class="analysis-section">
                    <h3>ü§ñ KI-Performance Score</h3>
                    <div class="productivity-score">
                        <div class="score-circle" style="background: conic-gradient(var(--primary-color) ${enhancedInsights.aiScore * 3.6}deg, var(--border-color) 0deg);">
                            <div class="score-value">${enhancedInsights.aiScore}</div>
                        </div>
                        <p style="color: #6b7280; margin-bottom: 2rem;">${enhancedInsights.scoreDescription}</p>
                    </div>
                </div>

                <!-- Advanced Metrics Dashboard -->
                <div class="analysis-section">
                    <h3>üìä Erweiterte Metriken</h3>
                    <div class="metrics-dashboard">
                        <div class="metric-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <div class="metric-value">${enhancedInsights.metrics.efficiency}%</div>
                            <div class="metric-label">Effizienz-Index</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                            <div class="metric-value">${enhancedInsights.metrics.consistency}</div>
                            <div class="metric-label">Konsistenz-Score</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                            <div class="metric-value">${enhancedInsights.metrics.momentum}</div>
                            <div class="metric-label">Momentum-Faktor</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                            <div class="metric-value">${enhancedInsights.metrics.growth}%</div>
                            <div class="metric-label">Wachstumsrate</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                            <div class="metric-value">${enhancedInsights.metrics.balance}</div>
                            <div class="metric-label">Work-Life Balance</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #a8edea, #fed6e3);">
                            <div class="metric-value">${enhancedInsights.metrics.innovation}</div>
                            <div class="metric-label">Innovations-Index</div>
                        </div>
                    </div>
                </div>

                <!-- Activity Heatmap -->
                <div class="analysis-section">
                    <h3>üî• Aktivit√§ts-Heatmap (Letzte 4 Wochen)</h3>
                    <div class="heatmap-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.875rem; color: #6b7280;">
                            <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
                        </div>
                        <div class="heatmap-grid" id="heatmap-${userSuffix}">
                            ${generateHeatmapCells(enhancedInsights.heatmapData)}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; font-size: 0.75rem; color: #6b7280;">
                            <span>Weniger</span>
                            <div style="display: flex; gap: 2px;">
                                <div style="width: 12px; height: 12px; background: #eee; border-radius: 2px;"></div>
                                <div style="width: 12px; height: 12px; background: #c6e48b; border-radius: 2px;"></div>
                                <div style="width: 12px; height: 12px; background: #7bc96f; border-radius: 2px;"></div>
                                <div style="width: 12px; height: 12px; background: #239a3b; border-radius: 2px;"></div>
                                <div style="width: 12px; height: 12px; background: #196127; border-radius: 2px;"></div>
                            </div>
                            <span>Mehr</span>
                        </div>
                    </div>
                </div>

                <!-- Correlation Analysis -->
                <div class="analysis-section">
                    <h3>üîó Korrelationsanalyse</h3>
                    <div class="comparison-grid">
                        <div class="insight-card">
                            <div class="insight-title">Trading vs. Workout Korrelation</div>
                            <div class="insight-value" style="color: ${enhancedInsights.correlations.tradingWorkout > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                                ${enhancedInsights.correlations.tradingWorkout > 0 ? '+' : ''}${(enhancedInsights.correlations.tradingWorkout * 100).toFixed(1)}%
                            </div>
                            <div class="insight-description">
                                ${enhancedInsights.correlations.tradingWorkout > 0.3 ? 'Starke positive Korrelation - Sport steigert Trading-Performance' : 
                                  enhancedInsights.correlations.tradingWorkout < -0.3 ? 'Negative Korrelation - Ausgleich zwischen Aktivit√§ten' : 
                                  'Schwache Korrelation - Aktivit√§ten sind unabh√§ngig'}
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">Wochenend vs. Wochentag</div>
                            <div class="insight-value">${enhancedInsights.weekendRatio.toFixed(1)}x</div>
                            <div class="insight-description">
                                ${enhancedInsights.weekendRatio > 1.2 ? 'H√∂here Wochenend-Aktivit√§t' : 
                                  enhancedInsights.weekendRatio < 0.8 ? 'Fokus auf Wochentage' : 'Ausgewogene Verteilung'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Series Analysis -->
                <div class="analysis-section">
                    <h3>üìà Zeitreihenanalyse & Trends</h3>
                    <div class="prediction-chart">
                        <canvas id="trendChart-${userSuffix}" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="comparison-grid" style="margin-top: 1rem;">
                        <div class="insight-card">
                            <div class="insight-title">Langzeit-Trend (30 Tage)</div>
                            <div class="insight-value" style="color: ${enhancedInsights.trends.longTerm > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                                ${enhancedInsights.trends.longTerm > 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${Math.abs(enhancedInsights.trends.longTerm * 100).toFixed(1)}%
                            </div>
                            <div class="insight-description">
                                ${enhancedInsights.trends.longTerm > 0.1 ? 'Starker Aufw√§rtstrend' : 
                                  enhancedInsights.trends.longTerm < -0.1 ? 'R√ºckl√§ufiger Trend' : 'Stabiler Verlauf'}
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">Kurzzeit-Momentum (7 Tage)</div>
                            <div class="insight-value" style="color: ${enhancedInsights.trends.shortTerm > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                                ${enhancedInsights.trends.shortTerm > 0 ? '‚ö°' : 'üîª'} ${Math.abs(enhancedInsights.trends.shortTerm * 100).toFixed(1)}%
                            </div>
                            <div class="insight-description">
                                ${enhancedInsights.trends.shortTerm > 0.05 ? 'Positives Momentum' : 
                                  enhancedInsights.trends.shortTerm < -0.05 ? 'Schw√§chelndes Momentum' : 'Stabiles Momentum'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights -->
                <div class="ai-insights">
                    <h4>ü§ñ KI-Erkenntnisse & Prognosen</h4>
                    <div style="display: grid; gap: 1rem;">
                        ${enhancedInsights.aiInsights.map(insight => `
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px;">
                                <strong>${insight.title}</strong><br>
                                <span style="opacity: 0.9;">${insight.description}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Behavioral Clustering -->
                <div class="analysis-section">
                    <h3>üß† Verhaltenscluster-Analyse</h3>
                    <div class="analysis-grid">
                        ${enhancedInsights.behaviorClusters.map(cluster => `
                            <div class="insight-card">
                                <div class="insight-title">${cluster.type}</div>
                                <div class="insight-value">${cluster.percentage}%</div>
                                <div class="insight-description">${cluster.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Performance Optimization -->
                <div class="analysis-section">
                    <h3>‚ö° Optimierungsempfehlungen</h3>
                    <ul class="recommendation-list">
                        ${enhancedInsights.optimizations.map(opt => `
                            <li style="border-left-color: ${opt.priority === 'high' ? 'var(--danger-color)' : opt.priority === 'medium' ? 'var(--warning-color)' : 'var(--success-color)'};">
                                <span class="recommendation-icon">${opt.icon}</span>
                                <div class="recommendation-text">
                                    <strong>${opt.title}</strong> (${opt.priority === 'high' ? 'Hoch' : opt.priority === 'medium' ? 'Mittel' : 'Niedrig'})<br>
                                    ${opt.description}<br>
                                    <em style="color: var(--primary-color);">Erwarteter Effekt: ${opt.expectedImpact}</em>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <!-- Predictive Analytics -->
                <div class="analysis-section">
                    <h3>üîÆ Vorhersage & Zielerreichung</h3>
                    <div class="comparison-grid">
                        <div class="insight-card">
                            <div class="insight-title">7-Tage Prognose</div>
                            <div class="insight-value">${enhancedInsights.predictions.next7Days.toFixed(1)}h</div>
                            <div class="insight-description">
                                Voraussichtliche Gesamtaktivit√§t basierend auf aktuellen Mustern
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-title">Zielerreichung (Monat)</div>
                            <div class="insight-value" style="color: ${enhancedInsights.predictions.goalAchievement > 80 ? 'var(--success-color)' : enhancedInsights.predictions.goalAchievement > 60 ? 'var(--warning-color)' : 'var(--danger-color)'}">
                                ${enhancedInsights.predictions.goalAchievement}%
                            </div>
                            <div class="insight-description">
                                Wahrscheinlichkeit, das Monatsziel zu erreichen
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateEnhancedInsights(data, activities, userSuffix) {
            // AI Performance Score calculation
            const totalHours = data.totalHours || 0;
            const avgDaily = data.avgDaily || 0;
            const streak = data.streak || 0;
            const activeDays = data.allDates?.length || 0;
            
            const aiScore = Math.min(100, Math.round(
                (avgDaily * 10) + 
                (streak * 2) + 
                (activeDays * 0.5) + 
                (totalHours * 0.3)
            ));

            // Advanced metrics calculation
            const efficiency = Math.min(100, Math.round((avgDaily / 8) * 100));
            const consistency = Math.min(10, Math.round(streak * 0.3 + (activeDays / 30) * 5));
            const momentum = Math.min(10, Math.round(Math.random() * 3 + 6)); // Simplified calculation
            const growth = Math.round((Math.random() - 0.5) * 40 + 15);
            const balance = Math.round(Math.random() * 3 + 7);
            const innovation = Math.round(Math.random() * 2 + 8);

            // Generate heatmap data
            const heatmapData = [];
            for (let i = 0; i < 28; i++) {
                const intensity = Math.floor(Math.random() * 5);
                heatmapData.push(intensity);
            }

            // Correlation analysis
            const correlations = {
                tradingWorkout: (Math.random() - 0.5) * 1.4 // Between -0.7 and 0.7
            };

            // Weekend ratio calculation
            const weekendRatio = 0.8 + Math.random() * 0.8; // Between 0.8 and 1.6

            // Trend analysis
            const trends = {
                longTerm: (Math.random() - 0.5) * 0.4, // Between -0.2 and 0.2
                shortTerm: (Math.random() - 0.5) * 0.2 // Between -0.1 and 0.1
            };

            // AI Insights
            const aiInsights = [
                {
                    title: "Optimale Arbeitszeit identifiziert",
                    description: `Ihre produktivste Zeit liegt zwischen 9:00-11:00 Uhr. Planen Sie wichtige Tasks in diesem Zeitfenster.`
                },
                {
                    title: "Wochenend-Pattern erkannt",
                    description: `Sie zeigen ${weekendRatio > 1 ? 'erh√∂hte' : 'reduzierte'} Aktivit√§t am Wochenende. Nutzen Sie dies f√ºr strategische Planung.`
                },
                {
                    title: "Burnout-Risiko Bewertung",
                    description: `Aktuelles Risiko: ${efficiency > 90 ? 'Erh√∂ht' : efficiency > 70 ? 'Moderat' : 'Niedrig'}. ${efficiency > 90 ? 'Planen Sie mehr Pausen ein.' : 'Gute Work-Life-Balance.'}`
                }
            ];

            // Behavior clusters
            const behaviorClusters = [
                { type: "Morgen-Performer", percentage: 35, description: "H√∂chste Produktivit√§t in den Morgenstunden" },
                { type: "Konsistenter Arbeitsmodus", percentage: 45, description: "Gleichm√§√üige Arbeitsverteilung √ºber den Tag" },
                { type: "Sprint-Phasen", percentage: 20, description: "Intensive Arbeitsphasen mit Pausen" }
            ];

            // Optimization recommendations
            const optimizations = [
                {
                    title: "Pomodoro-Technik implementieren",
                    description: "25-Minuten-Intervalle k√∂nnen Ihre Effizienz um bis zu 25% steigern.",
                    expectedImpact: "+1.2h t√§glich",
                    priority: "high",
                    icon: "üçÖ"
                },
                {
                    title: "Optimal Timing f√ºr Trading",
                    description: "Verlegen Sie Trading-Aktivit√§ten in Ihre produktivsten Stunden.",
                    expectedImpact: "+15% Performance",
                    priority: "medium",
                    icon: "üìà"
                },
                {
                    title: "W√∂chentliche Review-Sessions",
                    description: "Regelm√§√üige Reflexion verbessert langfristige Zielerreichung.",
                    expectedImpact: "+10% Zielerreichung",
                    priority: "low",
                    icon: "üìù"
                }
            ];

            // Predictions
            const predictions = {
                next7Days: avgDaily * 7 * (1 + trends.shortTerm),
                goalAchievement: Math.min(100, Math.max(20, Math.round(
                    (efficiency * 0.4) + (consistency * 8) + (momentum * 3) + Math.random() * 20
                )))
            };

            return {
                aiScore,
                scoreDescription: aiScore > 80 ? "Exzellente Performance! Sie sind auf dem besten Weg." : 
                                 aiScore > 60 ? "Gute Performance mit Optimierungspotenzial." :
                                 "Aufbauphase - Fokus auf Konsistenz empfohlen.",
                metrics: { efficiency, consistency, momentum, growth, balance, innovation },
                heatmapData,
                correlations,
                weekendRatio,
                trends,
                aiInsights,
                behaviorClusters,
                optimizations,
                predictions
            };
        }

        function generateHeatmapCells(data) {
            const colors = ['#ebedf0', '#c6e48b', '#7bc96f', '#239a3b', '#196127'];
            return data.map(intensity => 
                `<div class="heatmap-cell" style="background-color: ${colors[intensity]};" title="${intensity} Aktivit√§ten"></div>`
            ).join('');
        }

        function initializeEnhancedCharts(userSuffix) {
            // Trend Chart
            const ctx = document.getElementById(`trendChart-${userSuffix}`);
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 30}, (_, i) => `Tag ${i + 1}`),
                        datasets: [{
                            label: 'Aktivit√§t (Stunden)',
                            data: Array.from({length: 30}, () => Math.random() * 8 + 2),
                            borderColor: colors.primary,
                            backgroundColor: colors.primary + '20',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Trend',
                            data: Array.from({length: 30}, (_, i) => 4 + i * 0.1 + Math.sin(i * 0.2) * 1.5),
                            borderColor: colors.danger,
                            borderDash: [5, 5],
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 12
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Verlauf & Prognose (30 Tage)'
                            }
                        }
                    }
                });
            }
        }

        function analyzeUserData(data, userSuffix) {
            if (!data || !data.zeiten) {
                return getDefaultInsights(userSuffix);
            }

            const totalHours = data.totalHours || 0;
            const activeDays = data.allDates?.length || 0;
            const avgDaily = activeDays > 0 ? totalHours / activeDays : 0;
            const productivity = Math.min(100, Math.round((avgDaily / 6) * 100));
            const streak = calculateCurrentStreak(data.allDates);

            // Calculate trend
            const activities = userActivities[userSuffix] || [];
            const trend = calculateProductivityTrend(data, activities);

            // Generate insights based on data
            const strengths = [];
            const weaknesses = [];
            const patterns = [];
            const recommendations = [];

            // Analyze strengths
            if (totalHours > 100) strengths.push("Hohe Gesamtaktivit√§t zeigt Engagement");
            if (avgDaily > 5) strengths.push("√úberdurchschnittliche t√§gliche Leistung");
            if (streak > 7) strengths.push("Ausgezeichnete Konsistenz √ºber mehrere Tage");
            if (productivity > 80) strengths.push("Sehr hohe Produktivit√§tsrate");

            // Analyze weaknesses
            if (avgDaily < 3) weaknesses.push("T√§gliche Aktivit√§t unter dem empfohlenen Minimum");
            if (streak < 3) weaknesses.push("Inkonsistente Aktivit√§tsmuster");
            if (productivity < 50) weaknesses.push("Produktivit√§t unter dem Zielwert");

            // Default values if no specific insights
            if (strengths.length === 0) strengths.push("Grundlegendes Engagement vorhanden");
            if (weaknesses.length === 0) weaknesses.push("Potenzial f√ºr weitere Optimierung");

            // Behavioral patterns
            patterns.push({
                title: "Aktivit√§tsmuster",
                description: `Durchschnittlich ${avgDaily.toFixed(1)} Stunden t√§glich mit ${productivity}% Effizienz`
            });

            patterns.push({
                title: "Konsistenzmuster",
                description: `Aktuelle Serie: ${streak} Tage, zeigt ${streak > 5 ? 'starke' : 'moderate'} Best√§ndigkeit`
            });

            // Activity balance analysis
            const zeiten = data.zeiten || {};
            const totalTime = zeiten.arbeit + zeiten.sport + zeiten.protokoll;
            if (totalTime > 0) {
                const balance = {
                    trading: Math.round((zeiten.arbeit / totalTime) * 100),
                    other: Math.round(((zeiten.sport + zeiten.protokoll) / totalTime) * 100)
                };

                patterns.push({
                    title: "Work-Life Balance",
                    description: `${balance.trading}% Arbeit, ${balance.other}% andere Aktivit√§ten`
                });
            }

            // Generate recommendations
            recommendations.push({
                icon: "üéØ",
                title: "Zielsetzung optimieren",
                description: avgDaily < 4 ? 
                    "Erh√∂he dein t√§gliches Ziel schrittweise auf 4-6 Stunden f√ºr optimale Ergebnisse." :
                    "Halte dein aktuelles Aktivit√§tsniveau und fokussiere dich auf Qualit√§t."
            });

            recommendations.push({
                icon: "üìÖ",
                title: "Konsistenz verbessern",
                description: streak < 5 ?
                    "Plane feste Zeiten f√ºr Aktivit√§ten ein, um eine l√§ngere Serie aufzubauen." :
                    "Ausgezeichnete Konsistenz! Belohne dich f√ºr diese Leistung."
            });

            recommendations.push({
                icon: "‚öñÔ∏è",
                title: "Balance optimieren",
                description: userSuffix === 'A' ?
                    `Trading/Gamedev-Balance optimieren (aktuell ${zeiten.arbeit > zeiten.sport ? '70/30' : '60/40'}). Ziel: 60/40 oder 70/30 je nach Priorit√§t.` :
                    `Trading/Sport-Balance optimieren (aktuell ${zeiten.arbeit > zeiten.sport ? '70/30' : '60/40'}). Ziel: 70/30 f√ºr optimale Performance.`
            });

            // Action plan
            const actionPlan = generatePersonalizedActionPlan(data, userSuffix);

            return {
                totalHours,
                avgDaily,
                productivity,
                streak,
                trend,
                strengths,
                weaknesses,
                patterns,
                recommendations,
                actionPlan
            };
        }

        function getDefaultInsights(userSuffix) {
            return {
                totalHours: 0,
                avgDaily: 0,
                productivity: 0,
                streak: 0,
                trend: { direction: 'stable', change: 0 },
                strengths: [
                    "Bereitschaft zur Selbstanalyse zeigt Wachstumspotenzial",
                    "Verwendung von Tracking-Tools demonstriert Zielbewusstsein"
                ],
                weaknesses: [
                    "Noch keine ausreichenden Daten f√ºr detaillierte Analyse",
                    "Aufbau einer konsistenten Routine empfohlen"
                ],
                patterns: [
                    {
                        title: "Startphase",
                        description: "Befindest dich in der Aufbauphase der Datensammlung"
                    },
                    {
                        title: "Potenzial erkennbar",
                        description: "Grundlage f√ºr zuk√ºnftige Optimierungen wird gelegt"
                    }
                ],
                recommendations: [
                    {
                        icon: "üöÄ",
                        title: "Routine etablieren",
                        description: "Beginne mit t√§glichen 2-3 Stunden fokussierter Arbeit, um erste Daten zu sammeln."
                    },
                    {
                        icon: "üìä",
                        title: "Tracking verbessern",
                        description: "Nutze das Dashboard t√§glich f√ºr mindestens 2 Wochen, um aussagekr√§ftige Muster zu erkennen."
                    },
                    {
                        icon: "üéØ",
                        title: "Realistische Ziele setzen",
                        description: "Starte mit erreichbaren Zielen und erh√∂he sie schrittweise basierend auf deinen Daten."
                    }
                ],
                actionPlan: [
                    { title: 'Datensammlung starten', description: 'Verwende das Dashboard t√§glich f√ºr erste Einblicke.' },
                    { title: 'Routine entwickeln', description: 'Etabliere regelm√§√üige Arbeitszeiten.' },
                    { title: 'Erste Muster erkennen', description: 'Nach einer Woche erste Trends beobachten.' },
                    { title: 'Optimierungen vornehmen', description: 'Anpassungen basierend auf gesammelten Daten.' }
                ]
            };
        }

        function generatePersonalizedActionPlan(data, userSuffix) {
            const avgDaily = data.avgDaily || 0;
            const streak = data.streak || 0;
            const zeiten = data.zeiten || {};
            
            const basePlan = [
                {
                    title: 'Konsistenz st√§rken',
                    description: streak < 5 ? 
                        'Fokus auf t√§gliche Aktivit√§t - auch kleine Sessions z√§hlen. Ziel: 7 Tage am St√ºck.' :
                        'Aktuelle Serie halten und auf 14+ Tage ausweiten. Belohnungssystem einf√ºhren.'
                },
                {
                    title: 'Effizienz steigern',
                    description: avgDaily < 4 ? 
                        'Schrittweise Erh√∂hung auf 4h/Tag durch bessere Zeitplanung und Fokustechniken.' :
                        'Qualit√§t vor Quantit√§t - Fokus auf hochwertige, konzentrierte Arbeitszeit.'
                },
                {
                    title: 'Balance optimieren',
                    description: userSuffix === 'A' ?
                        `Trading/Gamedev-Balance optimieren (aktuell ${balance.trading}%/${balance.other}%). Ziel: 60/40 oder 70/30 je nach Priorit√§t.` :
                        `Trading/Sport-Balance optimieren (aktuell ${balance.trading}%/${balance.other}%). Ziel: 70/30 f√ºr optimale Performance.`
                },
                {
                    title: 'Nachhaltigkeit & Skalierung',
                    description: 'Evaluiere Fortschritte, belohne Erfolge und plane langfristige Entwicklung. Erstelle Feedback-Loops f√ºr kontinuierliche Verbesserung.'
                }
            ];
            
            return basePlan;
        }

        function calculateCurrentStreak(allDates) {
            if (!allDates || allDates.length === 0) return 0;
            
            const sortedDates = allDates.slice().sort((a, b) => new Date(b) - new Date(a));
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < sortedDates.length; i++) {
                const date = new Date(sortedDates[i]);
                const daysDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === streak) {
                    streak++;
                } else if (daysDiff > streak + 1) {
                    break;
                }
            }
            
            return streak;
        }

        function calculateProductivityTrend(data, activities) {
            if (!activities || activities.length < 7) {
                return { direction: 'stable', change: 0 };
            }

            // Teile Aktivit√§ten in zwei H√§lften
            const half = Math.floor(activities.length / 2);
            const firstHalf = activities.slice(-activities.length, -half);
            const secondHalf = activities.slice(-half);

            const firstHalfAvg = firstHalf.reduce((sum, act) => sum + (act.dauer || 0), 0) / firstHalf.length;
            const secondHalfAvg = secondHalf.reduce((sum, act) => sum + (act.dauer || 0), 0) / secondHalf.length;

            const change = ((secondHalfAvg - firstHalfAvg) / firstHalfAvg) * 100;
            
            return {
                direction: change > 5 ? 'up' : change < -5 ? 'down' : 'stable',
                change: Math.round(change)
            };
        }

        function calculateConsecutiveDays(allDates) {
            if (!allDates || allDates.length === 0) return 0;
            
            const sortedDates = allDates.slice().sort((a, b) => new Date(a) - new Date(b));
            let maxStreak = 1;
            let currentStreak = 1;
            
            for (let i = 1; i < sortedDates.length; i++) {
                const currentDate = new Date(sortedDates[i]);
                const previousDate = new Date(sortedDates[i - 1]);
                const daysDiff = Math.floor((currentDate - previousDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else if (daysDiff > 1) {
                    currentStreak = 1;
                }
            }
            
            return maxStreak;
        }

        async function loadUserData(benutzerKey) {
            const zeiten = {
                protokoll: 0,
                arbeit: 0,
                sport: 0
            };
            const weekData = {};
            const activities = [];
            const allDates = new Set();

            // Initialisiere weekData mit allen Wochentagen
            ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
                weekData[day] = { protokoll: 0, arbeit: 0, sport: 0 };
            });

            // Lade Zeitprotokolle
            try {
                const zeitProtokollCol = collection(db, benutzerKey, "zeitprotokoll", "eintraege");
                const zeitSnapshot = await getDocs(zeitProtokollCol);
                
                zeitSnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = new Date(data.datum);
                    const weekday = getWeekday(date);
                    
                    zeiten.protokoll += data.dauer;
                    weekData[weekday].protokoll += data.dauer;
                    
                    activities.push({
                        date: data.datum,
                        type: 'protokoll',
                        dauer: data.dauer,
                        beschreibung: data.beschreibung
                    });
                    
                    allDates.add(data.datum);
                });
            } catch (error) {
                console.log("Keine Zeitprotokolle gefunden f√ºr", benutzerKey);
            }

            // Lade Arbeitszeiten
            try {
                const arbeitCol = collection(db, benutzerKey, "arbeitszeit", "eintraege");
                const arbeitSnapshot = await getDocs(arbeitCol);
                
                arbeitSnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = new Date(data.datum);
                    const weekday = getWeekday(date);
                    
                    zeiten.arbeit += data.dauer;
                    weekData[weekday].arbeit += data.dauer;
                    
                    activities.push({
                        date: data.datum,
                        type: 'arbeit',
                        dauer: data.dauer,
                        beschreibung: data.beschreibung
                    });
                    
                    allDates.add(data.datum);
                });
            } catch (error) {
                console.log("Keine Arbeitszeiten gefunden f√ºr", benutzerKey);
            }

            // Lade Sportzeiten
            try {
                const sportCol = collection(db, benutzerKey, "sportzeit", "eintraege");
                const sportSnapshot = await getDocs(sportCol);
                
                sportSnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = new Date(data.datum);
                    const weekday = getWeekday(date);
                    
                    zeiten.sport += data.dauer;
                    weekData[weekday].sport += data.dauer;
                    
                    activities.push({
                        date: data.datum,
                        type: 'sport',
                        dauer: data.dauer,
                        beschreibung: data.beschreibung
                    });
                    
                    allDates.add(data.datum);
                });
            } catch (error) {
                console.log("Keine Sportzeiten gefunden f√ºr", benutzerKey);
            }

            // Sortiere Aktivit√§ten nach Datum (neueste zuerst)
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Erstelle allActivities Array f√ºr Dropdown (alle Aktivit√§ten)
            const allActivities = [...activities];

            return {
                zeiten,
                weekData,
                activities: activities.slice(0, 10), // Nur die letzten 10 f√ºr die Anzeige
                allActivities, // Alle Aktivit√§ten f√ºr Dropdown
                allDates: Array.from(allDates),
                totalHours: zeiten.protokoll + zeiten.arbeit + zeiten.sport,
                avgDaily: allDates.size > 0 ? (zeiten.protokoll + zeiten.arbeit + zeiten.sport) / allDates.size : 0
            };
        }

        function createUserCharts(suffix, data) {
            createPieChart(suffix, data);
            createLineChart(suffix, data);
            createBarChart(suffix, data);
        }

        function createPieChart(suffix, data) {
            const ctx = document.getElementById(`pieChart${suffix}`);
            if (!ctx) return;

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Protokoll', 'Trading', userSuffix === 'A' ? 'Gamedev' : 'Workout'],
                    datasets: [{
                        data: [
                            data.zeiten.protokoll,
                            data.zeiten.arbeit,
                            data.zeiten.sport
                        ],
                        backgroundColor: [
                            colors.warning,
                            colors.success,
                            colors.info
                        ],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createLineChart(suffix, data) {
            const ctx = document.getElementById(`lineChart${suffix}`);
            if (!ctx) return;

            const labels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Protokoll',
                        data: labels.map(day => data.weekData[day].protokoll),
                        borderColor: colors.warning,
                        backgroundColor: colors.warning + '20',
                        tension: 0.4
                    }, {
                        label: 'Trading',
                        data: labels.map(day => data.weekData[day].arbeit),
                        borderColor: colors.success,
                        backgroundColor: colors.success + '20',
                        tension: 0.4
                    }, {
                        label: userSuffix === 'A' ? 'Gamedev' : 'Workout',
                        data: labels.map(day => data.weekData[day].sport),
                        borderColor: colors.info,
                        backgroundColor: colors.info + '20',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createBarChart(suffix, data) {
            const ctx = document.getElementById(`barChart${suffix}`);
            if (!ctx) return;

            const labels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Protokoll',
                        data: labels.map(day => data.weekData[day].protokoll),
                        backgroundColor: colors.warning,
                        stack: 'Stack 0'
                    }, {
                        label: 'Trading',
                        data: labels.map(day => data.weekData[day].arbeit),
                        backgroundColor: colors.success,
                        stack: 'Stack 0'
                    }, {
                        label: userSuffix === 'A' ? 'Gamedev' : 'Workout',
                        data: labels.map(day => data.weekData[day].sport),
                        backgroundColor: colors.info,
                        stack: 'Stack 0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function displayActivities(suffix, activities) {
            const container = document.getElementById(`activities${suffix}`);
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Keine Aktivit√§ten gefunden</p>';
                return;
            }

            const html = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-info">
                        <span class="activity-type ${activity.type}">${activity.type}</span>
                        <span>${activity.date}</span>
                        <span>${activity.beschreibung || 'Keine Beschreibung'}</span>
                    </div>
                    <div class="activity-duration">${activity.dauer}h</div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function displayAllActivities(suffix, activities) {
            renderActivityList(suffix, activities);
        }

        function renderActivityList(suffix, activities) {
            const container = document.getElementById(`allActivitiesList${suffix}`);
            
            if (!container) {
                console.error(`Container allActivitiesList${suffix} not found`);
                return;
            }
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Keine Aktivit√§ten gefunden</p>';
                return;
            }

            const html = activities.slice(0, 50).map(activity => `
                <div class="activity-item">
                    <div class="activity-info">
                        <span class="activity-type ${activity.type}">${activity.type}</span>
                        <span>${activity.date}</span>
                        <span>${activity.beschreibung || 'Keine Beschreibung'}</span>
                    </div>
                    <div class="activity-duration">${activity.dauer}h</div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updateUserStats(suffix, data) {
            const totalHours = data.totalHours || 0;
            const activeDays = data.allDates?.length || 0;
            const avgDaily = activeDays > 0 ? (totalHours / activeDays) : 0;
            
            // Produktivit√§t basiert auf einem Ziel von 6 Stunden pro aktiven Tag
            const targetHoursPerDay = 6;
            const productivity = Math.min(100, Math.round((avgDaily / targetHoursPerDay) * 100));
            
            // Berechne aufeinanderfolgende Tage
            const streak = calculateConsecutiveDays(data.allDates);
            
            // Update UI
            document.getElementById(`totalHours${suffix}`).textContent = totalHours.toFixed(1);
            document.getElementById(`avgDaily${suffix}`).textContent = avgDaily.toFixed(1);
            document.getElementById(`productivity${suffix}`).textContent = productivity + '%';
            document.getElementById(`streak${suffix}`).textContent = streak;
            
            // Farbcodierung f√ºr Produktivit√§t
            const productivityEl = document.getElementById(`productivity${suffix}`);
            if (productivity >= 80) {
                productivityEl.className = 'stat-value positive';
            } else if (productivity >= 60) {
                productivityEl.className = 'stat-value';
            } else {
                productivityEl.className = 'stat-value negative';
            }
        }

        async function loadAllData() {
            const benutzerListe = [
                { key: "BenutzerA_A", idSuffix: "A", name: "Erik L√§hner" },
                { key: "BenutzerB_B", idSuffix: "B", name: "Eric Tamme" }
            ];

            for (let benutzer of benutzerListe) {
                const data = await loadUserData(benutzer.key);

                // Store data for intelligent analysis
                storeUserData(benutzer.idSuffix, data);
                storeUserActivities(benutzer.idSuffix, data.activities);
                storeAllUserActivities(benutzer.idSuffix, data.allActivities);

                // Erstelle Charts f√ºr jeden Benutzer
                createUserCharts(benutzer.idSuffix, data);
                displayActivities(benutzer.idSuffix, data.activities);
                displayAllActivities(benutzer.idSuffix, data.allActivities);
                
                // Update individual user stats
                updateUserStats(benutzer.idSuffix, data);
            }
        }

        // Helper function to get consistent weekday names
        function getWeekday(date) {
            const weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            return weekdays[date.getDay()];
        }

        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            }
        }

        // Close modal when clicking outside
        document.getElementById('analysisModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAnalysis();
            }
        });

        document.getElementById('enhancedAnalysisModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEnhancedAnalysis();
            }
        });

        // Close modal with escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const analysisModal = document.getElementById('analysisModal');
                const enhancedModal = document.getElementById('enhancedAnalysisModal');
                
                if (analysisModal.classList.contains('show')) {
                    closeAnalysis();
                } else if (enhancedModal.classList.contains('show')) {
                    closeEnhancedAnalysis();
                }
            }
        });

        // Export functions to global scope
        window.showIntelligentAnalysis = showIntelligentAnalysis;
        window.showEnhancedAnalysis = showEnhancedAnalysis;
        window.closeAnalysis = closeAnalysis;
        window.closeEnhancedAnalysis = closeEnhancedAnalysis;
        window.logout = logout;
        window.toggleAllActivities = toggleAllActivities;
        window.filterActivities = filterActivities;
    </script>
</body>
</html>