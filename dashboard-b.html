<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameChanger Dashboard</title>
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-color: #00ff88;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --danger-color: #ff4757;
            --warning-color: #ffa502;
            --card-bg: #1e1e1e;
            --border-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
            /* Prevent double-tap zoom on mobile */
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.15);
        }

        .stat-card h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--secondary-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #00cc6a);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .section {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .section h2 {
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-color), #00cc6a);
            color: #000;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            /* Prevent double-tap issues */
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, var(--danger-color), #ff3742);
            color: white;
        }

        .btn.warning {
            background: linear-gradient(135deg, var(--warning-color), #ff9500);
            color: white;
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .timer-btn {
            flex: 1;
            padding: 0.75rem;
            font-size: 0.9rem;
        }

        /* Loading spinner for buttons */
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-loading::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: rgba(255, 255, 255, 0.8);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        .theme-dark {
            --primary-bg: #000000;
            --secondary-bg: #111111;
            --card-bg: #0d1117;
            --border-color: #21262d;
        }

        .theme-light {
            --primary-bg: #ffffff;
            --secondary-bg: #f6f8fa;
            --card-bg: #ffffff;
            --text-primary: #24292f;
            --text-secondary: #656d76;
            --border-color: #d0d7de;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéÆ GameChanger Dashboard</h1>
            <p style="color: var(--text-secondary); font-size: 1.1rem;">Willkommen zur√ºck Eric! Zeit f√ºr maximale Produktivit√§t.</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìà Trading</h3>
                <div class="stat-value" id="tradingzeit">00:00:00</div>
                <div class="timer-controls">
                    <button class="btn timer-btn" id="tradingStart">‚ñ∂Ô∏è Start</button>
                    <button class="btn timer-btn" id="tradingStop">‚è∏Ô∏è Stop</button>
                </div>
            </div>

            <div class="stat-card">
                <h3>üèÉ‚Äç‚ôÇÔ∏è Sportzeit</h3>
                <div class="stat-value" id="sportzeit">00:00:00</div>
                <div class="timer-controls">
                    <button class="btn timer-btn" id="sportStart">‚ñ∂Ô∏è Start</button>
                    <button class="btn timer-btn" id="sportStop">‚è∏Ô∏è Stop</button>
                </div>
            </div>

            <div class="stat-card">
                <h3>üéπ Piano √úbungszeit</h3>
                <div class="stat-value" id="pianozeit">00:00:00</div>
                <div class="timer-controls">
                    <button class="btn timer-btn" id="pianoStart">‚ñ∂Ô∏è Start</button>
                    <button class="btn timer-btn" id="pianoStop">‚è∏Ô∏è Stop</button>
                </div>
            </div>

            <div class="stat-card">
                <h3>üéØ T√§gliches Ziel</h3>
                <div class="stat-value">3 Std.</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="tagesfortschritt" style="width: 0%"></div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;" id="fortschrittText">0% erreicht</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="section">
                <h2>üöÄ Quick Actions</h2>
                <div class="quick-actions">
                    <button class="btn" onclick="window.open('sk_course.html', '_blank')">üìì SK Course</button>
                    <button class="btn" onclick="window.open('journal-B.html', '_blank')">üìä Trading Journal</button>
                    <button class="btn" onclick="window.open('dashboard-admin.html', '_blank')">‚öôÔ∏è Admin Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 0.5rem;">
            <button class="btn warning" onclick="toggleTheme()">üé® Theme wechseln</button>
            <button class="btn danger" onclick="logout()">üîí Logout</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            addDoc,
            collection,
            serverTimestamp,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAujeUok4jKYwnr5GEXze_EadszqMdY1y4",
            authDomain: "gamechanger-78fb4.firebaseapp.com",
            projectId: "gamechanger-78fb4",
            storageBucket: "gamechanger-78fb4.firebasestorage.app",
            messagingSenderId: "510513691722",
            appId: "1:510513691722:web:c0c1a97141ddfda4377ab3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        const userKey = "BenutzerB";
        const dashboard = "B";

        let tradingStart = null;
        let tradingTimer = null;
        let sportStart = null;
        let sportTimer = null;
        let pianoStart = null;
        let pianoTimer = null;

        // Operation locks to prevent race conditions
        let tradingLocked = false;
        let sportLocked = false;
        let pianoLocked = false;

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
            const seconds = String(totalSeconds % 60).padStart(2, "0");
            return `${hours}:${minutes}:${seconds}`;
        }

        // Debounce function to prevent rapid multiple calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Set button loading state
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.classList.add('btn-loading');
                button.disabled = true;
                // Temporarily disable just for the loading period
                button.style.pointerEvents = 'none';
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                // Re-enable pointer events
                button.style.pointerEvents = 'auto';
            }
        }

        // Validate session state in Firebase
        async function validateSessionState(sessionName) {
            try {
                const ref = doc(db, "Benutzer_B", "training", "sessions", sessionName);
                const snapshot = await getDoc(ref);
                return snapshot.exists() && snapshot.data().aktiv;
            } catch (error) {
                console.error(`Error validating session state for ${sessionName}:`, error);
                return false;
            }
        }

        // Trading Functions
        async function startTrading() {
            if (tradingStart || tradingLocked) {
                console.log("Trading already active or locked");
                return;
            }
            
            tradingLocked = true;
            setButtonLoading('tradingStart', true);
            
            try {
                // Double-check Firebase state
                const isActive = await validateSessionState("trading_current");
                if (isActive) {
                    console.log("Trading session already active in Firebase");
                    tradingLocked = false;
                    setButtonLoading('tradingStart', false);
                    return;
                }
                
                tradingStart = Date.now();
                const ref = doc(db, "Benutzer_B", "training", "sessions", "trading_current");
                await setDoc(ref, {
                    startZeit: serverTimestamp(),
                    typ: "trading",
                    aktiv: true
                });

                tradingTimer = setInterval(updateTradingzeit, 1000);
                document.getElementById("tradingStart").style.opacity = "0.5";
                document.getElementById("tradingStop").style.opacity = "1";
                console.log("Trading session started successfully");
            } catch (error) {
                console.error("Error starting trading session:", error);
                tradingStart = null;
                if (tradingTimer) {
                    clearInterval(tradingTimer);
                    tradingTimer = null;
                }
            } finally {
                tradingLocked = false;
                setButtonLoading('tradingStart', false);
            }
        }

        async function stopTrading() {
            if (!tradingStart || tradingLocked) {
                console.log("Trading not active or locked");
                return;
            }

            tradingLocked = true;
            setButtonLoading('tradingStop', true);

            try {
                const dauer = Date.now() - tradingStart;
                const heute = new Date().toISOString().slice(0, 10);
                
                const tagesRef = doc(db, "Benutzer_B", "training", "tage", heute);
                const snapshot = await getDoc(tagesRef);
                const alteDauer = snapshot.exists() && snapshot.data().tradingzeit ? snapshot.data().tradingzeit : 0;

                await setDoc(tagesRef, {
                    tradingzeit: alteDauer + dauer,
                    letzteAktualisierung: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(db, "Benutzer_B", "aktivitaeten", "trading"), {
                    startZeit: new Date(tradingStart),
                    endZeit: new Date(),
                    dauer: dauer,
                    typ: "trading",
                    erstellt: serverTimestamp()
                });

                const sessionRef = doc(db, "Benutzer_B", "training", "sessions", "trading_current");
                await setDoc(sessionRef, {
                    aktiv: false,
                    endZeit: serverTimestamp(),
                    dauer: dauer
                }, { merge: true });

                tradingStart = null;
                clearInterval(tradingTimer);
                tradingTimer = null;
                document.getElementById("tradingStart").style.opacity = "1";
                document.getElementById("tradingStop").style.opacity = "0.5";
                updateProgress();
                console.log("Trading session stopped successfully");
            } catch (error) {
                console.error("Error stopping trading session:", error);
            } finally {
                tradingLocked = false;
                setButtonLoading('tradingStop', false);
            }
        }

        // Sport Functions
        async function startSport() {
            if (sportStart || sportLocked) {
                console.log("Sport already active or locked");
                return;
            }
            
            sportLocked = true;
            setButtonLoading('sportStart', true);
            
            try {
                // Double-check Firebase state
                const isActive = await validateSessionState("sport_current");
                if (isActive) {
                    console.log("Sport session already active in Firebase");
                    sportLocked = false;
                    setButtonLoading('sportStart', false);
                    return;
                }
                
                sportStart = Date.now();
                const ref = doc(db, "Benutzer_B", "training", "sessions", "sport_current");
                await setDoc(ref, {
                    startZeit: serverTimestamp(),
                    typ: "sport",
                    aktiv: true
                });

                sportTimer = setInterval(updateSportzeit, 1000);
                document.getElementById("sportStart").style.opacity = "0.5";
                document.getElementById("sportStop").style.opacity = "1";
                console.log("Sport session started successfully");
            } catch (error) {
                console.error("Error starting sport session:", error);
                sportStart = null;
                if (sportTimer) {
                    clearInterval(sportTimer);
                    sportTimer = null;
                }
            } finally {
                sportLocked = false;
                setButtonLoading('sportStart', false);
            }
        }

        async function stopSport() {
            if (!sportStart || sportLocked) {
                console.log("Sport not active or locked");
                return;
            }

            sportLocked = true;
            setButtonLoading('sportStop', true);

            try {
                const dauer = Date.now() - sportStart;
                const heute = new Date().toISOString().slice(0, 10);
                
                const tagesRef = doc(db, "Benutzer_B", "training", "tage", heute);
                const snapshot = await getDoc(tagesRef);
                const alteDauer = snapshot.exists() && snapshot.data().sportzeit ? snapshot.data().sportzeit : 0;

                await setDoc(tagesRef, {
                    sportzeit: alteDauer + dauer,
                    letzteAktualisierung: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(db, "Benutzer_B", "aktivitaeten", "sport"), {
                    startZeit: new Date(sportStart),
                    endZeit: new Date(),
                    dauer: dauer,
                    typ: "sport",
                    erstellt: serverTimestamp()
                });

                const sessionRef = doc(db, "Benutzer_B", "training", "sessions", "sport_current");
                await setDoc(sessionRef, {
                    aktiv: false,
                    endZeit: serverTimestamp(),
                    dauer: dauer
                }, { merge: true });

                sportStart = null;
                clearInterval(sportTimer);
                sportTimer = null;
                document.getElementById("sportStart").style.opacity = "1";
                document.getElementById("sportStop").style.opacity = "0.5";
                console.log("Sport session stopped successfully");
            } catch (error) {
                console.error("Error stopping sport session:", error);
            } finally {
                sportLocked = false;
                setButtonLoading('sportStop', false);
            }
        }

        // Piano Functions
        async function startPiano() {
            if (pianoStart || pianoLocked) {
                console.log("Piano already active or locked");
                return;
            }
            
            pianoLocked = true;
            setButtonLoading('pianoStart', true);
            
            try {
                // Double-check Firebase state
                const isActive = await validateSessionState("piano_current");
                if (isActive) {
                    console.log("Piano session already active in Firebase");
                    pianoLocked = false;
                    setButtonLoading('pianoStart', false);
                    return;
                }
                
                pianoStart = Date.now();
                const ref = doc(db, "Benutzer_B", "training", "sessions", "piano_current");
                await setDoc(ref, {
                    startZeit: serverTimestamp(),
                    typ: "piano",
                    aktiv: true
                });

                pianoTimer = setInterval(updatePianozeit, 1000);
                document.getElementById("pianoStart").style.opacity = "0.5";
                document.getElementById("pianoStop").style.opacity = "1";
                console.log("Piano session started successfully");
            } catch (error) {
                console.error("Error starting piano session:", error);
                pianoStart = null;
                if (pianoTimer) {
                    clearInterval(pianoTimer);
                    pianoTimer = null;
                }
            } finally {
                pianoLocked = false;
                setButtonLoading('pianoStart', false);
            }
        }

        async function stopPiano() {
            if (!pianoStart || pianoLocked) {
                console.log("Piano not active or locked");
                return;
            }

            pianoLocked = true;
            setButtonLoading('pianoStop', true);

            try {
                const dauer = Date.now() - pianoStart;
                const heute = new Date().toISOString().slice(0, 10);
                
                const tagesRef = doc(db, "Benutzer_B", "training", "tage", heute);
                const snapshot = await getDoc(tagesRef);
                const alteDauer = snapshot.exists() && snapshot.data().pianozeit ? snapshot.data().pianozeit : 0;

                await setDoc(tagesRef, {
                    pianozeit: alteDauer + dauer,
                    letzteAktualisierung: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(db, "Benutzer_B", "aktivitaeten", "piano"), {
                    startZeit: new Date(pianoStart),
                    endZeit: new Date(),
                    dauer: dauer,
                    typ: "piano",
                    erstellt: serverTimestamp()
                });

                const sessionRef = doc(db, "Benutzer_B", "training", "sessions", "piano_current");
                await setDoc(sessionRef, {
                    aktiv: false,
                    endZeit: serverTimestamp(),
                    dauer: dauer
                }, { merge: true });

                pianoStart = null;
                clearInterval(pianoTimer);
                pianoTimer = null;
                document.getElementById("pianoStart").style.opacity = "1";
                document.getElementById("pianoStop").style.opacity = "0.5";
                console.log("Piano session stopped successfully");
            } catch (error) {
                console.error("Error stopping piano session:", error);
            } finally {
                pianoLocked = false;
                setButtonLoading('pianoStop', false);
            }
        }

        // Update Timer Functions
        function updateTradingzeit() {
            if (tradingStart) {
                const dauer = Date.now() - tradingStart;
                document.getElementById("tradingzeit").textContent = formatTime(dauer);
            }
        }

        function updateSportzeit() {
            if (sportStart) {
                const dauer = Date.now() - sportStart;
                document.getElementById("sportzeit").textContent = formatTime(dauer);
            }
        }

        function updatePianozeit() {
            if (pianoStart) {
                const dauer = Date.now() - pianoStart;
                document.getElementById("pianozeit").textContent = formatTime(dauer);
            }
        }

        async function loadTageszeiten() {
            const heute = new Date().toISOString().slice(0, 10);
            const ref = doc(db, "Benutzer_B", "training", "tage", heute);
            const snapshot = await getDoc(ref);
            
            if (snapshot.exists()) {
                const data = snapshot.data();
                if (data.tradingzeit) {
                    document.getElementById("tradingzeit").textContent = formatTime(data.tradingzeit);
                }
                if (data.sportzeit) {
                    document.getElementById("sportzeit").textContent = formatTime(data.sportzeit);
                }
                if (data.pianozeit) {
                    document.getElementById("pianozeit").textContent = formatTime(data.pianozeit);
                }
            }

            // Check for active sessions and restore state
            try {
                const tradingSessionRef = doc(db, "Benutzer_B", "training", "sessions", "trading_current");
                const tradingSession = await getDoc(tradingSessionRef);
                if (tradingSession.exists() && tradingSession.data().aktiv && !tradingStart) {
                    tradingStart = tradingSession.data().startZeit.toMillis();
                    tradingTimer = setInterval(updateTradingzeit, 1000);
                    document.getElementById("tradingStart").style.opacity = "0.5";
                    document.getElementById("tradingStop").style.opacity = "1";
                    console.log("Restored active trading session");
                }

                const sportSessionRef = doc(db, "Benutzer_B", "training", "sessions", "sport_current");
                const sportSession = await getDoc(sportSessionRef);
                if (sportSession.exists() && sportSession.data().aktiv && !sportStart) {
                    sportStart = sportSession.data().startZeit.toMillis();
                    sportTimer = setInterval(updateSportzeit, 1000);
                    document.getElementById("sportStart").style.opacity = "0.5";
                    document.getElementById("sportStop").style.opacity = "1";
                    console.log("Restored active sport session");
                }

                const pianoSessionRef = doc(db, "Benutzer_B", "training", "sessions", "piano_current");
                const pianoSession = await getDoc(pianoSessionRef);
                if (pianoSession.exists() && pianoSession.data().aktiv && !pianoStart) {
                    pianoStart = pianoSession.data().startZeit.toMillis();
                    pianoTimer = setInterval(updatePianozeit, 1000);
                    document.getElementById("pianoStart").style.opacity = "0.5";
                    document.getElementById("pianoStop").style.opacity = "1";
                    console.log("Restored active piano session");
                }
            } catch (error) {
                console.error("Error loading active sessions:", error);
            }

            updateProgress();
        }

        async function updateProgress() {
            const heute = new Date().toISOString().slice(0, 10);
            const ref = doc(db, "Benutzer_B", "training", "tage", heute);
            const snapshot = await getDoc(ref);
            
            let gesamtzeit = 0;
            if (snapshot.exists()) {
                const data = snapshot.data();
                if (data.tradingzeit) gesamtzeit += data.tradingzeit;
                if (data.sportzeit) gesamtzeit += data.sportzeit;
                if (data.pianozeit) gesamtzeit += data.pianozeit;
            }
            
            // Add current running timers
            if (tradingStart) gesamtzeit += Date.now() - tradingStart;
            if (sportStart) gesamtzeit += Date.now() - sportStart;
            if (pianoStart) gesamtzeit += Date.now() - pianoStart;

            const zielZeit = 3 * 60 * 60 * 1000; // 3 Stunden in ms
            const prozent = Math.min((gesamtzeit / zielZeit) * 100, 100);
            
            document.getElementById("tagesfortschritt").style.width = prozent + "%";
            document.getElementById("fortschrittText").textContent = Math.round(prozent) + "% erreicht";
        }

        window.toggleTheme = function() {
            document.body.classList.toggle('theme-light');
            localStorage.setItem('theme', document.body.classList.contains('theme-light') ? 'light' : 'dark');
        }

        window.logout = function() {
            if (confirm("Wirklich ausloggen?")) {
                window.location.href = "login.html";
            }
        }

        onAuthStateChanged(auth, user => {
            if (!user) {
                console.log("Nicht eingeloggt");
                return;
            }
            console.log("Eingeloggt als:", user.email);
        });

        // Create debounced versions of the functions for mobile (reduced from 300ms to 200ms for better responsiveness)
        const debouncedStartTrading = debounce(startTrading, 200);
        const debouncedStopTrading = debounce(stopTrading, 200);
        const debouncedStartSport = debounce(startSport, 200);
        const debouncedStopSport = debounce(stopSport, 200);
        const debouncedStartPiano = debounce(startPiano, 200);
        const debouncedStopPiano = debounce(stopPiano, 200);

        // Event Listeners with debouncing
        document.getElementById("tradingStart").addEventListener("click", debouncedStartTrading);
        document.getElementById("tradingStop").addEventListener("click", debouncedStopTrading);
        document.getElementById("sportStart").addEventListener("click", debouncedStartSport);
        document.getElementById("sportStop").addEventListener("click", debouncedStopSport);
        document.getElementById("pianoStart").addEventListener("click", debouncedStartPiano);
        document.getElementById("pianoStop").addEventListener("click", debouncedStopPiano);

        // Prevent double-tap/zoom on mobile for all buttons (but allow clicks)
        document.querySelectorAll('.btn').forEach(button => {
            button.style.touchAction = 'manipulation';
            // Remove any potential pointer-events blocking
            button.style.pointerEvents = 'auto';
        });

        // Theme setup
        if (localStorage.getItem('theme') === 'dark') {
            // Keep default dark theme
        } else {
            document.body.classList.add('theme-light');
        }

        // Handle visibility change (app going to background/foreground)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log("App became visible, reloading session state");
                loadTageszeiten();
            }
        });

        // Initialization
        setInterval(updateProgress, 10000);
        await loadTageszeiten();
    </script>
</body>
</html>