<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Datenbankstruktur Migration - Phase 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 2rem;
        }

        .phase-info {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0 8px 8px 0;
        }

        .phase-info h2 {
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section h3 {
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .section h3 .icon {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        .btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .status-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
        }

        .status-card h4 {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-pending { background: #fbbf24; }
        .status-progress { background: #3b82f6; }
        .status-complete { background: #10b981; }
        .status-error { background: #ef4444; }

        .log {
            background: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .user-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .user-card {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .user-card h4 {
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .user-card .user-id {
            color: #6b7280;
            font-family: monospace;
            background: rgba(255,255,255,0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .collection-preview {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .collection-tree {
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #10b981;
            color: #065f46;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Firebase Datenbankstruktur Migration</h1>
            <p>Phase 1: Neue Struktur vorbereiten und Benutzer-Profile erstellen</p>
        </div>

        <div class="content">
            <div class="phase-info">
                <h2>📋 Phase 1 - Vorbereitung</h2>
                <p>In dieser Phase werden die neuen Benutzer-Profile erstellt und die Collection-Struktur vorbereitet. Es werden noch keine Daten migriert.</p>
            </div>

            <!-- Benutzer Information -->
            <div class="section">
                <h3><span class="icon">👥</span>Benutzer-Übersicht</h3>
                <div class="user-info">
                    <div class="user-card">
                        <h4>Dashboard A</h4>
                        <p><strong>Erik Lähner</strong></p>
                        <div class="user-id">BenutzerA</div>
                    </div>
                    <div class="user-card">
                        <h4>Dashboard B</h4>
                        <p><strong>Eric Tamme</strong></p>
                        <div class="user-id">BenutzerB</div>
                    </div>
                </div>
            </div>

            <!-- Aktuelle Struktur Analyse -->
            <div class="section">
                <h3><span class="icon">🔍</span>Aktuelle Struktur analysieren</h3>
                <button class="btn" onclick="analyzeCurrentStructure()">
                    📊 Analyse starten
                </button>
                <div id="analysisResults" style="margin-top: 1rem;"></div>
            </div>

            <!-- Neue Struktur Preview -->
            <div class="section">
                <h3><span class="icon">🏗️</span>Neue Struktur Vorschau</h3>
                <div class="collection-preview">
                    <div class="collection-tree" id="newStructurePreview">
users/
├── BenutzerA/                      # Erik Lähner (Dashboard A)
│   ├── profile/
│   │   └── info                    # Name, Dashboard, Einstellungen
│   ├── sessions/
│   │   ├── logins/                 # Login-Zeiten
│   │   └── activity-tracking/      # Live-Timer Status
│   ├── time-tracking/
│   │   ├── work-sessions/          # Arbeitszeiten
│   │   ├── sport-sessions/         # Sportzeiten
│   │   └── protocol-entries/       # Zeitprotokoll-Einträge
│   ├── tasks/                      # To-Do-Listen
│   └── analytics/                  # Dashboard-Daten
│
└── BenutzerB/                      # Eric Tamme (Dashboard B)
    ├── profile/
    │   └── info
    ├── sessions/
    │   ├── logins/
    │   └── activity-tracking/
    ├── time-tracking/
    │   ├── work-sessions/
    │   ├── sport-sessions/
    │   └── protocol-entries/
    ├── tasks/
    └── analytics/

shared/
├── appointments/                   # Geteilte Termine
├── games/                         # Schachspiele
└── system/                        # System-Einstellungen
                    </div>
                </div>
            </div>

            <!-- Migration Status -->
            <div class="section">
                <h3><span class="icon">⚙️</span>Phase 1 Durchführung</h3>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4><span class="status-indicator status-pending" id="profileStatus"></span>Benutzer-Profile</h4>
                        <p>Erstelle Benutzer-Profile mit Grundinformationen</p>
                    </div>
                    <div class="status-card">
                        <h4><span class="status-indicator status-pending" id="collectionsStatus"></span>Collections vorbereiten</h4>
                        <p>Lege neue Collection-Struktur an</p>
                    </div>
                    <div class="status-card">
                        <h4><span class="status-indicator status-pending" id="mappingStatus"></span>Mapping erstellen</h4>
                        <p>Erstelle Zuordnung alt → neu</p>
                    </div>
                    <div class="status-card">
                        <h4><span class="status-indicator status-pending" id="validationStatus"></span>Validierung</h4>
                        <p>Prüfe neue Struktur</p>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgress"></div>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="startPhase1()" id="startBtn">
                        🚀 Phase 1 starten
                    </button>
                    <button class="btn success" onclick="validateStructure()" id="validateBtn" disabled>
                        ✅ Struktur validieren
                    </button>
                    <button class="btn warning" onclick="resetPhase1()" id="resetBtn">
                        🔄 Zurücksetzen
                    </button>
                </div>
            </div>

            <!-- Log Ausgabe -->
            <div class="section">
                <h3><span class="icon">📝</span>Aktivitäts-Log</h3>
                <div class="log" id="logOutput">Bereit für Phase 1 Migration...\n</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            getDocs,
            collection,
            serverTimestamp,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAujeUok4jKYwnr5GEXze_EadszqMdY1y4",
            authDomain: "gamechanger-78fb4.firebaseapp.com",
            projectId: "gamechanger-78fb4",
            storageBucket: "gamechanger-78fb4.firebasestorage.app",
            messagingSenderId: "510513691722",
            appId: "1:510513691722:web:c0c1a97141ddfda4377ab3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // Globale Variablen
        let currentProgress = 0;
        let analysisData = {};
        
        // Benutzer-Konfiguration
        const users = {
            BenutzerA: {
                name: "Erik Lähner",
                dashboard: "A",
                oldKeys: ["BenutzerA", "BenutzerA_A"],
                email: "erik@gamechanger.com"
            },
            BenutzerB: {
                name: "Eric Tamme", 
                dashboard: "B",
                oldKeys: ["BenutzerB", "BenutzerB_B"],
                email: "eric@gamechanger.com"
            }
        };

        // Collections Mapping (alt → neu)
        const collectionMapping = {
            // Zeitprotokolle: zeitprotokolle/BenutzerX_Y → users/BenutzerX/time-tracking/protocol-entries/
            zeitprotokolle: (userId) => `users/${userId}/time-tracking/protocol-entries`,
            
            // Logins: logins/BenutzerX_Y → users/BenutzerX/sessions/logins/
            logins: (userId) => `users/${userId}/sessions/logins`,
            
            // Arbeitszeiten: arbeitszeiten/BenutzerX/eintraege → users/BenutzerX/time-tracking/work-sessions/
            arbeitszeiten: (userId) => `users/${userId}/time-tracking/work-sessions`,
            
            // Sportzeiten: sportzeiten/BenutzerX/eintraege → users/BenutzerX/time-tracking/sport-sessions/
            sportzeiten: (userId) => `users/${userId}/time-tracking/sport-sessions`,
            
            // Aufgaben: aufgaben/BenutzerX → users/BenutzerX/tasks/
            aufgaben: (userId) => `users/${userId}/tasks`,
            
            // Termine bleiben shared: termine → shared/appointments
            termine: () => 'shared/appointments',
            
            // Games bleiben shared: games → shared/games
            games: () => 'shared/games'
        };

        // Utility Funktionen
        function log(message, type = 'info') {
            const logEl = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateProgress(percentage) {
            currentProgress = percentage;
            document.getElementById('overallProgress').style.width = percentage + '%';
        }

        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator status-${status}`;
        }

        // Firebase Auth Check
        onAuthStateChanged(auth, user => {
            if (!user) {
                log("⚠️ Bitte zuerst einloggen", 'warning');
                return;
            }
            log(`👤 Angemeldet als: ${user.email}`, 'success');
        });

        // Aktuelle Struktur analysieren
        window.analyzeCurrentStructure = async function() {
            log("🔍 Starte Analyse der aktuellen Datenbankstruktur...");
            
            try {
                const collections = ['zeitprotokolle', 'logins', 'arbeitszeiten', 'sportzeiten', 'aufgaben', 'termine', 'games'];
                const results = {};
                
                for (const collectionName of collections) {
                    log(`📊 Analysiere Collection: ${collectionName}`);
                    
                    try {
                        const snapshot = await getDocs(collection(db, collectionName));
                        results[collectionName] = {
                            docCount: snapshot.size,
                            docs: []
                        };
                        
                        snapshot.forEach(doc => {
                            results[collectionName].docs.push({
                                id: doc.id,
                                hasData: !doc.empty,
                                size: JSON.stringify(doc.data()).length
                            });
                        });
                        
                        log(`✅ ${collectionName}: ${snapshot.size} Dokumente gefunden`);
                    } catch (error) {
                        results[collectionName] = { error: error.message };
                        log(`❌ Fehler bei ${collectionName}: ${error.message}`, 'error');
                    }
                }
                
                analysisData = results;
                displayAnalysisResults(results);
                log("✅ Struktur-Analyse abgeschlossen", 'success');
                
            } catch (error) {
                log(`❌ Fehler bei Analyse: ${error.message}`, 'error');
            }
        };

        function displayAnalysisResults(results) {
            const container = document.getElementById('analysisResults');
            
            let html = '<div class="alert alert-info"><strong>📊 Analyse-Ergebnisse:</strong></div>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">';
            
            for (const [collectionName, data] of Object.entries(results)) {
                const docCount = data.docCount || 0;
                const hasError = data.error;
                
                html += `
                    <div class="status-card">
                        <h4>${hasError ? '❌' : '📁'} ${collectionName}</h4>
                        <p>${hasError ? `Fehler: ${data.error}` : `${docCount} Dokumente`}</p>
                        ${!hasError && data.docs ? `<small>${data.docs.map(d => d.id).join(', ')}</small>` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Phase 1 starten
        window.startPhase1 = async function() {
            log("🚀 Starte Phase 1: Neue Struktur vorbereiten...");
            document.getElementById('startBtn').disabled = true;
            
            try {
                // Schritt 1: Benutzer-Profile erstellen
                updateStatus('profileStatus', 'progress');
                await createUserProfiles();
                updateStatus('profileStatus', 'complete');
                updateProgress(25);
                
                // Schritt 2: Collections vorbereiten
                updateStatus('collectionsStatus', 'progress');
                await prepareCollections();
                updateStatus('collectionsStatus', 'complete');
                updateProgress(50);
                
                // Schritt 3: Mapping erstellen
                updateStatus('mappingStatus', 'progress');
                await createMapping();
                updateStatus('mappingStatus', 'complete');
                updateProgress(75);
                
                // Schritt 4: Struktur validieren
                updateStatus('validationStatus', 'progress');
                await validateNewStructure();
                updateStatus('validationStatus', 'complete');
                updateProgress(100);
                
                document.getElementById('validateBtn').disabled = false;
                log("🎉 Phase 1 erfolgreich abgeschlossen!", 'success');
                
            } catch (error) {
                log(`❌ Fehler in Phase 1: ${error.message}`, 'error');
                document.getElementById('startBtn').disabled = false;
            }
        };

        async function createUserProfiles() {
            log("👥 Erstelle Benutzer-Profile...");
            const batch = writeBatch(db);
            
            for (const [userId, userData] of Object.entries(users)) {
                const profileDoc = doc(db, `users/${userId}/profile/info`);
                
                const profileData = {
                    name: userData.name,
                    dashboard: userData.dashboard,
                    email: userData.email,
                    settings: {
                        theme: "light",
                        notifications: true,
                        timezone: "Europe/Berlin",
                        language: "de"
                    },
                    migration: {
                        phase1Completed: serverTimestamp(),
                        oldKeys: userData.oldKeys,
                        migrationVersion: "1.0"
                    },
                    created: serverTimestamp(),
                    lastUpdated: serverTimestamp()
                };
                
                batch.set(profileDoc, profileData);
                log(`✅ Profil vorbereitet für: ${userData.name} (${userId})`);
            }
            
            await batch.commit();
            log("✅ Alle Benutzer-Profile erstellt", 'success');
        }

        async function prepareCollections() {
            log("🏗️ Bereite neue Collection-Struktur vor...");
            const batch = writeBatch(db);
            
            for (const [userId, userData] of Object.entries(users)) {
                // Sessions vorbereiten
                const sessionsDoc = doc(db, `users/${userId}/sessions/meta`);
                batch.set(sessionsDoc, {
                    initialized: serverTimestamp(),
                    structure: "v1.0"
                });
                
                // Time-tracking vorbereiten
                const timeTrackingDoc = doc(db, `users/${userId}/time-tracking/meta`);
                batch.set(timeTrackingDoc, {
                    initialized: serverTimestamp(),
                    structure: "v1.0",
                    categories: ["work", "sport", "protocol"]
                });
                
                // Tasks vorbereiten
                const tasksDoc = doc(db, `users/${userId}/tasks/meta`);
                batch.set(tasksDoc, {
                    initialized: serverTimestamp(),
                    structure: "v1.0"
                });
                
                // Analytics vorbereiten
                const analyticsDoc = doc(db, `users/${userId}/analytics/meta`);
                batch.set(analyticsDoc, {
                    initialized: serverTimestamp(),
                    structure: "v1.0"
                });
                
                log(`✅ Collections vorbereitet für: ${userData.name}`);
            }
            
            // Shared Collections vorbereiten
            const sharedMetaDoc = doc(db, 'shared/meta');
            batch.set(sharedMetaDoc, {
                initialized: serverTimestamp(),
                structure: "v1.0",
                collections: ["appointments", "games", "system"]
            });
            
            await batch.commit();
            log("✅ Alle Collection-Strukturen vorbereitet", 'success');
        }

        async function createMapping() {
            log("🗺️ Erstelle Migrations-Mapping...");
            
            const mappingDoc = doc(db, 'admin/migration-mapping');
            const mappingData = {
                version: "1.0",
                created: serverTimestamp(),
                users: users,
                collectionMapping: {
                    zeitprotokolle: "time-tracking/protocol-entries",
                    logins: "sessions/logins", 
                    arbeitszeiten: "time-tracking/work-sessions",
                    sportzeiten: "time-tracking/sport-sessions",
                    aufgaben: "tasks",
                    termine: "shared/appointments",
                    games: "shared/games"
                },
                phase1Completed: serverTimestamp()
            };
            
            await setDoc(mappingDoc, mappingData);
            log("✅ Migrations-Mapping erstellt", 'success');
        }

        async function validateNewStructure() {
            log("🔍 Validiere neue Struktur...");
            
            const validationResults = [];
            
            // Prüfe Benutzer-Profile
            for (const userId of Object.keys(users)) {
                try {
                    const profileDoc = await getDoc(doc(db, `users/${userId}/profile/info`));
                    if (profileDoc.exists()) {
                        validationResults.push(`✅ Profil für ${userId} erstellt`);
                        log(`✅ Profil für ${userId} validiert`);
                    } else {
                        validationResults.push(`❌ Profil für ${userId} fehlt`);
                        log(`❌ Profil für ${userId} fehlt`, 'error');
                    }
                } catch (error) {
                    validationResults.push(`❌ Fehler bei ${userId}: ${error.message}`);
                    log(`❌ Validierungsfehler für ${userId}: ${error.message}`, 'error');
                }
            }
            
            // Prüfe Mapping
            try {
                const mappingDoc = await getDoc(doc(db, 'admin/migration-mapping'));
                if (mappingDoc.exists()) {
                    validationResults.push("✅ Migrations-Mapping vorhanden");
                    log("✅ Migrations-Mapping validiert");
                } else {
                    validationResults.push("❌ Migrations-Mapping fehlt");
                    log("❌ Migrations-Mapping fehlt", 'error');
                }
            } catch (error) {
                validationResults.push(`❌ Mapping-Fehler: ${error.message}`);
                log(`❌ Mapping-Validierungsfehler: ${error.message}`, 'error');
            }
            
            log("✅ Struktur-Validierung abgeschlossen", 'success');
            return validationResults;
        }

        // Validierung durchführen
        window.validateStructure = async function() {
            log("🔍 Führe detaillierte Validierung durch...");
            
            try {
                const results = await validateNewStructure();
                
                let html = '<div class="alert alert-info"><strong>✅ Validierungs-Ergebnisse:</strong></div>';
                html += '<ul>';
                results.forEach(result => {
                    html += `<li>${result}</li>`;
                });
                html += '</ul>';
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.getElementById('analysisResults').appendChild(container);
                
                log("✅ Detaillierte Validierung abgeschlossen", 'success');
                
            } catch (error) {
                log(`❌ Validierungsfehler: ${error.message}`, 'error');
            }
        };

        // Reset Phase 1
        window.resetPhase1 = async function() {
            if (!confirm('⚠️ Möchten Sie Phase 1 wirklich zurücksetzen? Dies löscht alle vorbereiteten Strukturen!')) {
                return;
            }
            
            log("🔄 Setze Phase 1 zurück...");
            
            try {
                // Reset Progress
                updateProgress(0);
                updateStatus('profileStatus', 'pending');
                updateStatus('collectionsStatus', 'pending');
                updateStatus('mappingStatus', 'pending');
                updateStatus('validationStatus', 'pending');
                
                // Reset Buttons
                document.getElementById('startBtn').disabled = false;
                document.getElementById('validateBtn').disabled = true;
                
                log("✅ Phase 1 zurückgesetzt", 'success');
                
            } catch (error) {
                log(`❌ Fehler beim Zurücksetzen: ${error.message}`, 'error');
            }
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            log("🔧 Migration Tool initialisiert");
            log("📋 Bereit für Phase 1 - Struktur vorbereiten");
        });
    </script>
</body>
</html>