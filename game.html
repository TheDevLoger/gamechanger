<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire Conquest - Strategiespiel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
            overflow-x: auto;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        .game-board {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            height: fit-content;
        }

        .world-map {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            min-height: 600px;
        }

        .territory {
            position: absolute;
            border: 2px solid #34495e;
            border-radius: 8px;
            background: #3498db;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .territory:hover {
            transform: scale(1.05);
            border-color: #f39c12;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
        }

        .territory.player1 {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .territory.player2 {
            background: #27ae60;
            border-color: #229954;
        }

        .territory.selected {
            border-color: #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            transform: scale(1.1);
        }

        .territory.attackable {
            border-color: #e67e22;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .army-count {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 4px 8px;
            font-size: 14px;
            margin-top: 5px;
        }

        .game-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        .phase-info {
            background: rgba(52, 152, 219, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .player-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin: 5px 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn.success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }

        .dice-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .dice {
            width: 40px;
            height: 40px;
            background: white;
            color: #2c3e50;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .battle-result {
            background: rgba(231, 76, 60, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .connected {
            background: #27ae60;
        }

        .disconnected {
            background: #e74c3c;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .game-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Territorien-Positionen auf der Karte */
        .territory[data-id="europe"] { top: 20%; left: 45%; width: 80px; height: 60px; }
        .territory[data-id="asia"] { top: 25%; left: 65%; width: 100px; height: 80px; }
        .territory[data-id="africa"] { top: 50%; left: 48%; width: 70px; height: 90px; }
        .territory[data-id="north-america"] { top: 30%; left: 15%; width: 120px; height: 100px; }
        .territory[data-id="south-america"] { top: 60%; left: 25%; width: 80px; height: 100px; }
        .territory[data-id="australia"] { top: 70%; left: 75%; width: 90px; height: 60px; }
        .territory[data-id="middle-east"] { top: 45%; left: 58%; width: 60px; height: 50px; }
        .territory[data-id="russia"] { top: 15%; left: 60%; width: 120px; height: 50px; }
        .territory[data-id="scandinavia"] { top: 10%; left: 48%; width: 70px; height: 40px; }
        .territory[data-id="britain"] { top: 25%; left: 40%; width: 50px; height: 40px; }
        .territory[data-id="greenland"] { top: 5%; left: 25%; width: 60px; height: 40px; }
        .territory[data-id="alaska"] { top: 20%; left: 5%; width: 60px; height: 50px; }

        @media (max-width: 1200px) {
            .game-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Verbinde...</div>
    
    <div class="game-container">
        <div class="game-board">
            <div class="game-title">üåç Empire Conquest</div>
            
            <div class="game-status" id="gameStatus">Spiel wird geladen...</div>
            
            <div class="world-map" id="worldMap">
                <div class="territory" data-id="europe">
                    Europa
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="asia">
                    Asien
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="africa">
                    Afrika
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="north-america">
                    Nordamerika
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="south-america">
                    S√ºdamerika
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="australia">
                    Australien
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="middle-east">
                    Naher Osten
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="russia">
                    Russland
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="scandinavia">
                    Skandinavien
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="britain">
                    Britannien
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="greenland">
                    Gr√∂nland
                    <div class="army-count">0</div>
                </div>
                <div class="territory" data-id="alaska">
                    Alaska
                    <div class="army-count">0</div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="phase-info" id="phaseInfo">
                <h3>Aktuelle Phase:</h3>
                <p id="currentPhase">Verst√§rkungsphase</p>
            </div>

            <div class="player-info">
                <h3>Spieler Information</h3>
                <div id="playerInfo">
                    <p><strong>Du bist:</strong> <span id="playerColor">Warten...</span></p>
                    <p><strong>Am Zug:</strong> <span id="currentTurn">Warten...</span></p>
                    <p><strong>Verf√ºgbare Armeen:</strong> <span id="availableArmies">0</span></p>
                </div>
            </div>

            <div id="gameActions">
                <button class="btn" id="joinPlayer1Btn">üî¥ Beitritt als Spieler 1 (Rot)</button>
                <button class="btn" id="joinPlayer2Btn">üü¢ Beitritt als Spieler 2 (Gr√ºn)</button>
                <button class="btn" id="endTurnBtn" disabled>‚úÖ Zug beenden</button>
                <button class="btn danger" id="newGameBtn">üîÑ Neues Spiel</button>
            </div>

            <div id="battleSection" style="display: none;">
                <h3>‚öîÔ∏è Schlacht</h3>
                <div id="battleInfo"></div>
                <div class="dice-container" id="diceContainer"></div>
                <div id="battleResult" class="battle-result" style="display: none;"></div>
                <button class="btn danger" id="attackBtn" disabled>üó°Ô∏è Angreifen</button>
                <button class="btn" id="cancelAttackBtn">‚ùå Abbrechen</button>
            </div>

            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p>Warte auf Mitspieler...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyAujeUok4jKYwnr5GEXze_EadszqMdY1y4",
            authDomain: "gamechanger-78fb4.firebaseapp.com",
            projectId: "gamechanger-78fb4",
            storageBucket: "gamechanger-78fb4.firebasestorage.app",
            messagingSenderId: "510513691722",
            appId: "1:510513691722:web:c0c1a97141ddfda4377ab3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Spiel-Zustand
        let gameState = {
            territories: {},
            currentPlayer: 1,
            phase: 'setup', // setup, reinforce, attack, fortify
            players: {},
            gameId: 'demo-game-' + Date.now()
        };

        let playerId = null;
        let playerNumber = null;
        let selectedTerritory = null;
        let targetTerritory = null;

        // Territorien-Verbindungen (welche Territorien grenzen aneinander)
        const connections = {
            'europe': ['asia', 'africa', 'scandinavia', 'britain', 'middle-east'],
            'asia': ['europe', 'russia', 'middle-east', 'australia'],
            'africa': ['europe', 'middle-east', 'south-america'],
            'north-america': ['south-america', 'greenland', 'alaska'],
            'south-america': ['north-america', 'africa'],
            'australia': ['asia'],
            'middle-east': ['europe', 'asia', 'africa'],
            'russia': ['asia', 'scandinavia', 'alaska'],
            'scandinavia': ['europe', 'russia', 'britain', 'greenland'],
            'britain': ['europe', 'scandinavia', 'greenland'],
            'greenland': ['north-america', 'scandinavia', 'britain', 'alaska'],
            'alaska': ['north-america', 'russia', 'greenland']
        };

        // DOM Elemente
        const territories = document.querySelectorAll('.territory');
        const gameStatus = document.getElementById('gameStatus');
        const currentPhase = document.getElementById('currentPhase');
        const playerColor = document.getElementById('playerColor');
        const currentTurn = document.getElementById('currentTurn');
        const availableArmies = document.getElementById('availableArmies');
        const joinPlayer1Btn = document.getElementById('joinPlayer1Btn');
        const joinPlayer2Btn = document.getElementById('joinPlayer2Btn');
        const endTurnBtn = document.getElementById('endTurnBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const battleSection = document.getElementById('battleSection');
        const attackBtn = document.getElementById('attackBtn');
        const cancelAttackBtn = document.getElementById('cancelAttackBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const loadingSection = document.getElementById('loadingSection');

        // Initialisierung
        function initGame() {
            playerId = 'player_' + Math.random().toString(36).substr(2, 9);
            
            // Territorien initialisieren
            const territoryNames = ['europe', 'asia', 'africa', 'north-america', 'south-america', 
                                  'australia', 'middle-east', 'russia', 'scandinavia', 'britain', 
                                  'greenland', 'alaska'];

            territoryNames.forEach(name => {
                gameState.territories[name] = {
                    owner: null,
                    armies: 0
                };
            });

            // Event Listeners
            territories.forEach(territory => {
                territory.addEventListener('click', handleTerritoryClick);
            });

            joinPlayer1Btn.addEventListener('click', () => joinGame(1));
            joinPlayer2Btn.addEventListener('click', () => joinGame(2));
            endTurnBtn.addEventListener('click', endTurn);
            newGameBtn.addEventListener('click', startNewGame);
            attackBtn.addEventListener('click', performAttack);
            cancelAttackBtn.addEventListener('click', cancelAttack);

            // Firebase Listener
            setupFirebaseListener();
            
            updateUI();
        }

        function setupFirebaseListener() {
            const gameRef = db.collection('empire-games').doc(gameState.gameId);
            
            gameRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    console.log('Firebase Update erhalten:', data);
                    
                    // Merge mit aktuellem gameState
                    gameState = { ...gameState, ...data };
                    
                    // Pr√ºfen ob der aktuelle Spieler schon im gameState ist
                    if (data.players && data.players[playerId] && !playerNumber) {
                        playerNumber = data.players[playerId].number;
                        console.log('Spielernummer aus Firebase wiederhergestellt:', playerNumber);
                    }
                    
                    updateUI();
                    connectionStatus.textContent = 'Verbunden';
                    connectionStatus.className = 'connection-status connected';
                } else {
                    console.log('Firebase Dokument existiert nicht');
                    connectionStatus.textContent = 'Getrennt';
                    connectionStatus.className = 'connection-status disconnected';
                }
            }, (error) => {
                console.error('Firebase Fehler:', error);
                connectionStatus.textContent = 'Fehler';
                connectionStatus.className = 'connection-status disconnected';
            });
        }

        function joinGame(desiredPlayerNumber) {
            console.log('Spieler versucht beizutreten als Spieler', desiredPlayerNumber);
            
            // Pr√ºfen ob gew√ºnschter Slot bereits belegt ist
            const existingPlayer = Object.values(gameState.players).find(p => p.number === desiredPlayerNumber);
            if (existingPlayer) {
                alert(`Spieler ${desiredPlayerNumber} ist bereits belegt!`);
                return;
            }

            // Pr√ºfen ob Spieler bereits im Spiel ist
            if (gameState.players[playerId]) {
                alert('Du bist bereits im Spiel!');
                return;
            }

            playerNumber = desiredPlayerNumber;
            gameState.players[playerId] = {
                number: playerNumber,
                joinedAt: Date.now()
            };

            console.log('Spieler beigetreten als Spieler', playerNumber);
            console.log('Aktuelle Spieleranzahl:', Object.keys(gameState.players).length);

            // Wenn zwei Spieler da sind, starte das Spiel
            if (Object.keys(gameState.players).length === 2) {
                console.log('Beide Spieler da, starte Spiel...');
                startGameSetup();
            } else {
                // Spielstand auch bei einem Spieler speichern
                saveGameState();
            }

            updateJoinButtons();
            updateUI();
        }

        function startGameSetup() {
            console.log('Starte Spielsetup...');
            gameState.phase = 'setup';
            gameState.currentPlayer = 1;
            
            // Territorien zuf√§llig aufteilen
            const territoryNames = Object.keys(gameState.territories);
            const shuffled = territoryNames.sort(() => Math.random() - 0.5);
            
            shuffled.forEach((name, index) => {
                const owner = (index % 2) + 1;
                gameState.territories[name] = {
                    owner: owner,
                    armies: 3 // Jedes Territorium startet mit 3 Armeen
                };
            });

            gameState.phase = 'reinforce';
            gameState.availableArmies = { 1: 5, 2: 5 }; // Jeder Spieler bekommt 5 zus√§tzliche Armeen
            
            console.log('Spielsetup abgeschlossen, Phase:', gameState.phase);
            console.log('Verf√ºgbare Armeen:', gameState.availableArmies);
            
            // Spiel sofort speichern
            saveGameState();
        }

        function handleTerritoryClick(event) {
            const territoryId = event.target.dataset.id;
            const territory = gameState.territories[territoryId];

            if (!territory) return;

            if (gameState.phase === 'reinforce') {
                handleReinforceClick(territoryId, territory);
            } else if (gameState.phase === 'attack') {
                handleAttackClick(territoryId, territory);
            }
        }

        function handleReinforceClick(territoryId, territory) {
            if (!isMyTurn()) return;
            
            if (territory.owner === playerNumber) {
                if (gameState.availableArmies[playerNumber] > 0) {
                    territory.armies++;
                    gameState.availableArmies[playerNumber]--;
                    saveGameState();
                }
            }
        }

        function handleAttackClick(territoryId, territory) {
            if (!isMyTurn()) return;

            if (!selectedTerritory) {
                // Erstes Territorium ausw√§hlen (muss eigenes sein)
                if (territory.owner === playerNumber && territory.armies > 1) {
                    selectedTerritory = territoryId;
                    updateTerritoryHighlights();
            updateJoinButtons();
                }
            } else {
                // Zweites Territorium ausw√§hlen
                if (territoryId === selectedTerritory) {
                    // Auswahl aufheben
                    selectedTerritory = null;
                    targetTerritory = null;
                    updateTerritoryHighlights();
                    hideBattleSection();
                } else if (territory.owner !== playerNumber && 
                          connections[selectedTerritory].includes(territoryId)) {
                    // Angriffsziel ausw√§hlen
                    targetTerritory = territoryId;
                    showBattleSection();
                } else {
                    // Anderes eigenes Territorium ausw√§hlen
                    if (territory.owner === playerNumber && territory.armies > 1) {
                        selectedTerritory = territoryId;
                        targetTerritory = null;
                        updateTerritoryHighlights();
                        hideBattleSection();
                    }
                }
            }
        }

        function showBattleSection() {
            battleSection.style.display = 'block';
            const attackerArmies = gameState.territories[selectedTerritory].armies;
            const defenderArmies = gameState.territories[targetTerritory].armies;
            
            document.getElementById('battleInfo').innerHTML = `
                <p><strong>Angreifer:</strong> ${getTranslatedName(selectedTerritory)} (${attackerArmies} Armeen)</p>
                <p><strong>Verteidiger:</strong> ${getTranslatedName(targetTerritory)} (${defenderArmies} Armeen)</p>
            `;
            
            attackBtn.disabled = false;
        }

        function hideBattleSection() {
            battleSection.style.display = 'none';
            attackBtn.disabled = true;
            document.getElementById('battleResult').style.display = 'none';
        }

        function performAttack() {
            if (!selectedTerritory || !targetTerritory) return;

            const attacker = gameState.territories[selectedTerritory];
            const defender = gameState.territories[targetTerritory];

            if (attacker.armies <= 1) {
                alert('Du brauchst mindestens 2 Armeen um anzugreifen!');
                return;
            }

            // W√ºrfeln
            const attackerDice = rollDice(Math.min(3, attacker.armies - 1));
            const defenderDice = rollDice(Math.min(2, defender.armies));

            // W√ºrfel sortieren (h√∂chste zuerst)
            attackerDice.sort((a, b) => b - a);
            defenderDice.sort((a, b) => b - a);

            // K√§mpfe auswerten
            let attackerLosses = 0;
            let defenderLosses = 0;

            for (let i = 0; i < Math.min(attackerDice.length, defenderDice.length); i++) {
                if (attackerDice[i] > defenderDice[i]) {
                    defenderLosses++;
                } else {
                    attackerLosses++;
                }
            }

            // Verluste anwenden
            attacker.armies -= attackerLosses;
            defender.armies -= defenderLosses;

            // Territorium erobern wenn Verteidiger keine Armeen mehr hat
            if (defender.armies === 0) {
                defender.owner = playerNumber;
                defender.armies = attacker.armies - 1;
                attacker.armies = 1;
                
                // Pr√ºfen ob Spiel gewonnen
                if (checkVictory()) {
                    gameState.phase = 'ended';
                    gameState.winner = playerNumber;
                }
            }

            // W√ºrfelergebnisse anzeigen
            showBattleResult(attackerDice, defenderDice, attackerLosses, defenderLosses);

            // Spiel aktualisieren
            if (gameState.phase !== 'ended') {
                // Schlacht zur√ºcksetzen wenn Angreifer nicht mehr kann
                if (attacker.armies <= 1 || defender.armies === 0) {
                    selectedTerritory = null;
                    targetTerritory = null;
                    hideBattleSection();
                    updateTerritoryHighlights();
                }
            }

            saveGameState();
        }

        function rollDice(count) {
            const dice = [];
            for (let i = 0; i < count; i++) {
                dice.push(Math.floor(Math.random() * 6) + 1);
            }
            return dice;
        }

        function showBattleResult(attackerDice, defenderDice, attackerLosses, defenderLosses) {
            const diceContainer = document.getElementById('diceContainer');
            const battleResult = document.getElementById('battleResult');
            
            diceContainer.innerHTML = `
                <div>
                    <h4>Angreifer:</h4>
                    ${attackerDice.map(d => `<div class="dice">${d}</div>`).join('')}
                </div>
                <div>
                    <h4>Verteidiger:</h4>
                    ${defenderDice.map(d => `<div class="dice">${d}</div>`).join('')}
                </div>
            `;
            
            battleResult.innerHTML = `
                <p><strong>Verluste:</strong></p>
                <p>Angreifer: ${attackerLosses} Armeen</p>
                <p>Verteidiger: ${defenderLosses} Armeen</p>
            `;
            battleResult.style.display = 'block';
        }

        function checkVictory() {
            const playerTerritories = Object.values(gameState.territories)
                .filter(t => t.owner === playerNumber);
            return playerTerritories.length === Object.keys(gameState.territories).length;
        }

        function endTurn() {
            if (!isMyTurn()) return;

            selectedTerritory = null;
            targetTerritory = null;
            hideBattleSection();
            updateTerritoryHighlights();

            if (gameState.phase === 'reinforce') {
                gameState.phase = 'attack';
            } else if (gameState.phase === 'attack') {
                gameState.phase = 'reinforce';
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                
                // Neue Armeen f√ºr n√§chsten Spieler berechnen
                const playerTerritories = Object.values(gameState.territories)
                    .filter(t => t.owner === gameState.currentPlayer).length;
                const newArmies = Math.max(3, Math.floor(playerTerritories / 3));
                
                if (!gameState.availableArmies) gameState.availableArmies = {};
                gameState.availableArmies[gameState.currentPlayer] = newArmies;
            }

            saveGameState();
        }

        function startNewGame() {
            if (confirm('Wirklich ein neues Spiel starten?')) {
                console.log('Starte neues Spiel...');
                
                gameState.gameId = 'demo-game-' + Date.now();
                gameState.phase = 'setup';
                gameState.currentPlayer = 1;
                gameState.players = {};
                gameState.availableArmies = {};
                gameState.winner = null;
                
                Object.keys(gameState.territories).forEach(name => {
                    gameState.territories[name] = {
                        owner: null,
                        armies: 0
                    };
                });

                selectedTerritory = null;
                targetTerritory = null;
                playerNumber = null;
                
                // Buttons wieder anzeigen
                joinPlayer1Btn.style.display = 'block';
                joinPlayer2Btn.style.display = 'block';
                joinPlayer1Btn.disabled = false;
                joinPlayer2Btn.disabled = false;
                
                hideBattleSection();
                setupFirebaseListener();
                updateUI();
                
                console.log('Neues Spiel gestartet mit ID:', gameState.gameId);
            }
        }

        function cancelAttack() {
            selectedTerritory = null;
            targetTerritory = null;
            hideBattleSection();
            updateTerritoryHighlights();
        }

        function updateTerritoryHighlights() {
            territories.forEach(territory => {
                const territoryId = territory.dataset.id;
                territory.classList.remove('selected', 'attackable');
                
                if (selectedTerritory === territoryId) {
                    territory.classList.add('selected');
                } else if (selectedTerritory && gameState.phase === 'attack' &&
                          connections[selectedTerritory].includes(territoryId) &&
                          gameState.territories[territoryId].owner !== playerNumber) {
                    territory.classList.add('attackable');
                }
            });
        }

        function updateUI() {
            // Territorien aktualisieren
            territories.forEach(territory => {
                const territoryId = territory.dataset.id;
                const territoryData = gameState.territories[territoryId];
                
                if (territoryData) {
                    const armyCount = territory.querySelector('.army-count');
                    armyCount.textContent = territoryData.armies;
                    
                    territory.className = 'territory';
                    if (territoryData.owner === 1) {
                        territory.classList.add('player1');
                    } else if (territoryData.owner === 2) {
                        territory.classList.add('player2');
                    }
                }
            });

            // Spielinformationen aktualisieren
            currentPhase.textContent = getPhaseText();
            
            if (playerNumber) {
                playerColor.textContent = playerNumber === 1 ? 'Rot (Spieler 1)' : 'Gr√ºn (Spieler 2)';
                currentTurn.textContent = gameState.currentPlayer === 1 ? 'Rot (Spieler 1)' : 'Gr√ºn (Spieler 2)';
                
                const available = gameState.availableArmies?.[playerNumber] || 0;
                availableArmies.textContent = available;
                
                endTurnBtn.disabled = !isMyTurn();
            } else {
                playerColor.textContent = 'Warten auf Beitritt...';
                currentTurn.textContent = 'Warten...';
                availableArmies.textContent = '0';
                endTurnBtn.disabled = true;
            }

            // Spielstatus aktualisieren
            if (gameState.phase === 'ended') {
                gameStatus.textContent = `üéâ Spieler ${gameState.winner} hat gewonnen!`;
                endTurnBtn.disabled = true;
            } else if (Object.keys(gameState.players).length < 2) {
                gameStatus.textContent = 'Warte auf zweiten Spieler...';
                loadingSection.style.display = 'block';
            } else {
                gameStatus.textContent = `Spieler ${gameState.currentPlayer} ist am Zug`;
                loadingSection.style.display = 'none';
            }

            updateTerritoryHighlights();
        }

        function getPhaseText() {
            switch (gameState.phase) {
                case 'setup': return 'Spielvorbereitung';
                case 'reinforce': return 'Verst√§rkungsphase';
                case 'attack': return 'Angriffsphase';
                case 'ended': return 'Spiel beendet';
                default: return 'Unbekannte Phase';
            }
        }

        function getTranslatedName(territoryId) {
            const translations = {
                'europe': 'Europa',
                'asia': 'Asien',
                'africa': 'Afrika',
                'north-america': 'Nordamerika',
                'south-america': 'S√ºdamerika',
                'australia': 'Australien',
                'middle-east': 'Naher Osten',
                'russia': 'Russland',
                'scandinavia': 'Skandinavien',
                'britain': 'Britannien',
                'greenland': 'Gr√∂nland',
                'alaska': 'Alaska'
            };
            return translations[territoryId] || territoryId;
        }

        function isMyTurn() {
            return playerNumber === gameState.currentPlayer && 
                   Object.keys(gameState.players).length === 2 &&
                   gameState.phase !== 'ended';
        }

        function saveGameState() {
            console.log('Speichere Spielstand...', gameState);
            const gameRef = db.collection('empire-games').doc(gameState.gameId);
            gameRef.set(gameState).then(() => {
                console.log('Spielstand erfolgreich gespeichert');
            }).catch(error => {
                console.error('Fehler beim Speichern:', error);
            });
        }

        // Spiel starten
        initGame();
    </script>
</body>
</html>